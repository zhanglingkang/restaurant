/*! ppz_website 2014-10-16 6:36:22 PM */
var ppzRestaurantControllers=angular.module("ppzControllers",[]);ppzRestaurantControllers.controller("appController",["$rootScope","$scope","$cookies","$location",function(a,b,c,d){function e(){return!(!c.token||"null"===c.token)}a.REQUEST_STATUS={INIT:0,REQUESTING:1,REQUEST_SUCCESSED:2,REQUEST_FAILED:3},a.KEY_CODE={ENTER:13,BACKSPACE:8,TOP:38,RIGHT:39,BOTTOM:40,LEFT:37},b.$on("$locationChangeStart",function(a,b){e()||/login/.test(b)||d.path("/login")})}]),ppzRestaurantControllers.controller("loginController",["$scope","Login","$window","$location","$cookies",function(a,b,c,d,e){a.getUserName=function(){return e.username},a.resetPasswordForm={userName:""},a.submitted=!1,a.active=function(){return"null"!==e.token},a.initResetInfo=function(){a.resetPasswordForm.userName="",a.resetStatus=a.REQUEST_STATUS.INIT,a.submitted=!1},a.resetStatus=a.REQUEST_STATUS.INIT,a.resetPassword=function(c){a.submitted=!0,c&&(a.resetStatus=a.REQUEST_STATUS.REQUESTING,b.resetPassword(a.resetPasswordForm.userName,function(){a.resetStatus=a.REQUEST_STATUS.REQUEST_SUCCESSED},function(b){a.resetStatus=a.REQUEST_STATUS.REQUEST_FAILED,a.resetHint=b.message}))},a.loginStatus=a.REQUEST_STATUS.INIT,a.performLogin=function(){var c=b;a.loginHintShow=!0,a.loginStatus=a.REQUEST_STATUS.REQUESTING,c.login(a.username,a.password).then(function(b){a.loginStatus=a.REQUEST_STATUS.REQUEST_SUCCESSED,console.log("login result "+b),console.log("token "+e.token),d.path("/myRestaurants")},function(b){a.loginStatus=a.REQUEST_STATUS.REQUEST_FAILED,console.log("login failed "+b)})},a.logout=function(){b.logout(function(){d.path("/login")})}}]),ppzRestaurantControllers.controller("restaurantListController",["$scope","RestaurantService",function(a,b){a.loading=!0,a.includeHeader=!0,b.getMyRestaurantList(function(b,c){a.loading=!1,a.error=b,a.restaurantList=c})}]),ppzRestaurantControllers.controller("restaurantDetailController",["$scope","$routeParams","RestaurantService","MenuService",function(a,b,c){a.goBack=function(){window.history.back()},a.restaurantId=b.restaurantId,c.getRestaurant(a.restaurantId,function(b,c){a.error=b,a.restaurant=c,a.newInfo=angular.copy(a.restaurant)}),a.editing=!1,a.edit=function(){a.editing=!0},a.cancel=function(){a.newInfo=angular.copy(a.restaurant),a.editing=!1},a.confirm=function(){a.editing=!1,c.updateRestaurantInfo(a.restaurantId,a.newInfo).then(function(){a.saved=!0},function(){a.saved=!1})}}]),ppzRestaurantControllers.controller("menuController",["$scope","MenuService",function(a,b){a.addingNewItem=!1,a.importMenuFile=[],a.wantImport=!1,a.importStatus=a.REQUEST_STATUS.INIT,a.isExcel=function(){return/application\/.+office.+/.test(a.importMenuFile[0].type)},a.importMenu=function(){a.wantImport=!0,a.importMenuFile.length>0&&a.isExcel()&&(a.importStatus=a.REQUEST_STATUS.REQUESTING,b.importMenu(a.importMenuFile[0],a.restaurantId).then(function(){a.importStatus=a.REQUEST_STATUS.REQUEST_SUCCESSED},function(){a.importStatus=a.REQUEST_STATUS.REQUEST_FAILED}))},a.refreshMenu=function(){b.getMenu(a.restaurantId,function(b,c){a.error=b,a.menu=c})},a.collapseAll=function(b){a.$broadcast("collapse",b)},a.refreshMenu(),a.addNewItem=function(){a.addingNewItem||(a.addingNewItem=!0)},a.confirmAddItem=function(){var c=a.newCategoryCategory;c.items=[a.newCategoryItem],a.menu.menuCategories.push(c),a.newModel=null,a.addingNewItem=!1,a.saved="saving",b.updateMenu({restaurantId:a.menu.restaurantId,menuCategories:[c]},function(b,c){b?a.saved=!1:(a.saved=!0,a.menu=c)})},a.cancelAddItem=function(){a.newModel=null,a.newCategoryForm.$setPristine(),a.addingNewItem=!1}}]),ppzRestaurantControllers.controller("menuCategoryController",["$scope","MenuService",function(a,b){$(".collapse").collapse(),a.addingNewItem=!1,a.editing=!1,a.nameModified=a.category.categoryName,a.descriptionModified=a.category.categoryDescription,a.editCategory=function(){a.editing||(a.editing=!0)},a.confirmEditCategory=function(){a.category.categoryName=a.nameModified,a.category.categoryDescription=a.descriptionModified,a.editing=!1,a.saved="saving",b.updateMenu(a.menu,function(b){a.saved=b?!1:!0})},a.$on("collapse",function(b,c){a.collapse=c}),a.cancelEditCategory=function(){a.nameModified=a.category.categoryName,a.descriptionModified=a.category.categoryDescription,a.categoryEditForm.$setPristine(),a.editing=!1},a.addNewItem=function(){a.addingNewItem||(a.addingNewItem=!0)},a.confirmAddItem=function(){if(a.newForm.$valid){var c=angular.copy(a.category);c.items=[],c.items.push(a.newItem),a.category.items.push(a.newItem),a.newItem=null,a.addingNewItem=!1,a.saved="saving",b.updateMenu({restaurantId:a.menu.restaurantId,menuCategories:[c]},function(b){a.saved=b?!1:!0})}},a.cancelAddItem=function(){a.newItem=null,a.newForm.$setPristine(),a.addingNewItem=!1},a.toggleMenuCategory=function(a){$("#"+a).collapse("toggle")}}]),ppzRestaurantControllers.controller("menuItemController",["$scope","MenuService",function(a,b){a.editing=!1,a.newItem=angular.copy(a.item),a.editItem=function(){a.editing||(a.editing=!0)},a.confirmEditItem=function(){a.item.itemName=a.newItem.itemName,a.item.itemDescription=a.newItem.itemDescription,a.item.price=a.newItem.price,a.editing=!1,a.saved="saving",b.updateMenu({restaurantId:a.menu.restaurantId,menuCategories:[a.category]},function(b){a.saved=b?!1:!0})},a.cancelEditItem=function(){a.newItem=angular.copy(a.item),a.editing=!1},a.removeItem=function(){a.item.deleted=!0,a.item.itemName="",a.saved="saving",b.updateMenu(a.menu,function(b){a.saved=b?!1:!0})}}]),ppzRestaurantControllers.controller("waitingListController",["$modal","$scope","$routeParams","$timeout","$window","RestaurantService","WaitingListService",function(a,b,c,d,e,f,g){var h=1e4,i=null;b.goBack=function(){window.history.back()},b.restaurantId=c.restaurantId,f.getRestaurant(b.restaurantId,function(a,c){b.error=a,b.partyTypeList=c.partyTypeInfos}),b.waitingList=[],b.newReserve={time:new Date};var j=function(){f.getWaitingList(b.restaurantId,function(a,c){b.error=a,b.waitingList=c.waitingList,b.reservationList=c.reservationList,b.completeList=c.completeList})},k=function(){d(function(){j(),k()},h)};b.call=function(a,c){i&&(i.lastCalledUnit=a,i.lastCalledUnitPrefix=c),g.callUser(b.restaurantId,a.unitId,function(b,c){b||(a.callCount=c.callCount)})},b.openPublicWaitListWindow=function(){i=e.open("#/publicWaitList/"+b.restaurantId),i.partyTypes=b.partyTypeList,i.lastCalledNumbers={};for(var a=0;a<i.partyTypes.length;a++){var c=i.partyTypes[a],d="--";b.waitingList[a+1].length>0&&(d=b.waitingList[a+1][0].unitId),i.lastCalledNumbers[c.unitIdPrefix]=d}},b.remove=function(a,c,d){var e=a[c],f=e.unitId.charAt(0),h=null;a[c+1]&&(h=a[c+1]),g.removeUser(b.restaurantId,e.unitId,d,function(b){null!=b?(alert(b),a.splice(c,1)):i&&0==c&&(i.lastReplacedUnit=h,i.lastReplacedUnitPrefix=f)})},b.addUser=function(a){var c=a?b.newReserve.time:null,d=b.newReserve.typeId;g.addUser(b.restaurantId,b.newReserve.name,b.newReserve.typeId,b.newReserve.phone,c,function(c,e){b.error=c,c||(a?b.reservationList.push(e):(0==b.waitingList[d].length&&i&&(i.lastReplacedUnit=e,i.lastReplacedUnitPrefix=e.unitId.charAt(0)),b.waitingList[d].push(e)),b.newReserve={time:new Date},b.reserveForm.$setPristine(),$("li[typeId="+d+"]").hide(),$("li[typeId="+d+"]").slideDown())})},b.openConfirmation=function(c,d,e){var f=a.open({templateUrl:"confirmationModal.html",size:"sm",controller:confirmationModalController,resolve:{queueUnit:function(){return c[d]}}});f.result.then(function(){b.remove(c,d,e)},function(){})},b.openPrintView=function(a,c){var d=e.open("#/printNumber/"+a.unitId);if(c)d.printPartyTypeDescription=c.partyTypeDescription;else for(var f=a.unitId.charAt(0),g=0;g<b.partyTypeList.length;g++){var c=b.partyTypeList[g];if(f==c.unitIdPrefix){d.printPartyTypeDescription="(预约)"+c.partyTypeDescription;break}}d.printUnitId=a.unitId},j(),k()}]);var confirmationModalController=function(a,b,c){a.unit=c,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}};ppzRestaurantControllers.controller("publicWaitListController",["$rootScope","$scope","$timeout","$window",function(a,b,c,d){b.partyTypes=d.partyTypes,a.excludeHeader=!0,b.lastCalledNumbers=d.lastCalledNumbers,b.panelTypes={};for(var e=0;e<b.partyTypes.length;e++){var f=b.partyTypes[e];b.panelTypes[f.unitIdPrefix]="panel-info"}console.log(JSON.stringify(b.lastCalledNumbers));var g=1e3,h=function(){d.lastReplacedUnitPrefix&&(b.lastCalledNumbers[d.lastReplacedUnitPrefix]=d.lastReplacedUnit?d.lastReplacedUnit.unitId:"--",d.lastReplacedUnitPrefix=null);var a=d.lastCalledUnit,c=b.currentPrefix,e=d.lastCalledUnitPrefix;if(e){var f=b.units,g=0;if(f||(b.units={},f=b.units),f[e]&&(g=f[e].callCount),g!=a.callCount){var h="现在叫号, "+a.unitId,i=new SpeechSynthesisUtterance(h);i.lang="zh-CN",window.speechSynthesis.speak(i)}c&&c!=e&&(b.panelTypes[c]="panel-info"),g!=a.callCount&&(b.lastCalledNumbers[e]=a.unitId,b.panelTypes[e]="panel-primary animate-flicker"),b.currentPrefix=e,f[e]=a}},i=function(){c(function(){h(),i()},g)};h(),i()}]),ppzRestaurantControllers.controller("reviewListController",["$scope","$routeParams","$timeout","ReviewService",function(a,b,c,d){a.loading=!0,a.currentPage=1,a.selectPage=function(b){d.getReviewList(a.restaurantId,b-1,function(b,c){a.loading=!1,a.error=b,a.reviewList=c})},a.selectPage(1)}]),ppzRestaurantControllers.controller("reviewItemController",["$scope","ReviewService",function(a,b){a.replying=!1,a.reply=function(){a.replying||(a.replying=!0)},a.confirmReply=function(){a.review.replyMessage=a.message,a.replying=!1,b.replyReview(a.restaurantId,a.review.reviewIndex,a.message,function(b){a.saved=b?!1:!0})},a.cancelReply=function(){a.review.replyMessage=null,a.replying=!1}}]),ppzRestaurantControllers.controller("printNumberController",["$scope","$window","$rootScope","$timeout",function(a,b,c,d){c.excludeHeader=!0,a.partyTypeDescription=b.printPartyTypeDescription,a.unitId=b.printUnitId,d(function(){window.print()},.5)}]),ppzRestaurantControllers.controller("fileUploader",["$cookies","$scope","FileUploadService","FileUploader","RestaurantService",function(a,b,c,d,e){var f=new FormData;f.append("sessionId",a.token),f.append("restaurantId",b.restaurantId),b.uploader=new d({url:c.FILE_SERVER_URL,formData:[{sessionId:a.token},{restaurantId:b.restaurantId},{userId:a.username},{pictureComment:void 0}]}),b.filePathList=[],b.uploader.onSuccessItem=function(a,c){var d=JSON.parse(c.data).results;b.filePathList.push(d[0].filePath)},e.getMyRestaurantList().then(function(a){a.results[0].uploadedPictures.forEach(function(a){b.filePathList.push(a.filePath)})})}]),ppzRestaurantControllers.controller("manageAccountController",["$cookies","$scope","manageAccountService",function(a,b,c){b.submitted=!1,b.modifyPasswordForm={oldPassword:"",newPassword:"",againPassword:""},b.modifyPasswordStatus=b.REQUEST_STATUS.INIT,b.modifyPassword=function(a){b.submitted=!0,b.modifyPasswordStatus=b.REQUEST_STATUS.INIT,a&&b.modifyPasswordForm.newPassword===b.modifyPasswordForm.againPassword&&(b.modifyPasswordStatus=b.REQUEST_STATUS.REQUESTING,c.modifyPassword(b.modifyPasswordForm.oldPassword,b.modifyPasswordForm.newPassword,function(){b.modifyPasswordStatus=b.REQUEST_STATUS.REQUEST_SUCCESSED},function(a){b.modifyPasswordStatus=b.REQUEST_STATUS.REQUEST_FAILED,angular.isObject(a)&&17==a.code&&(b.failHint="旧密码不正确")}))},b.modifyEmailStatus=b.REQUEST_STATUS.INIT,b.wantModifyEmail=!1,b.modifyEmail=function(a){b.wantModifyEmail=!0,b.modifyEmailStatus=b.REQUEST_STATUS.INIT,a&&(b.modifyEmailStatus=b.REQUEST_STATUS.REQUESTING,c.modifyEmail(b.email,function(){b.modifyEmailStatus=b.REQUEST_STATUS.REQUEST_SUCCESSED},function(){b.modifyEmailStatus=b.REQUEST_STATUS.REQUEST_FAILED,b.modifyEmailHint="修改email失败"}))},c.getUserInfo().then(function(a){b.email=a.results[0].email})}]);
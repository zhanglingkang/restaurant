/*! ppz_website 2015-01-12 6:59:27 PM */
"use strict";define(function(a){var b=a("app"),c=(a("public/general/util"),a("public/general/pub-sub"));a("public/local/reservation-service"),a("public/general/audio-service"),a("public/local/data-service"),a("public/general/notification-service"),a("./directive"),b.controller("appController",["$rootScope","$scope","$cookies","$location","$mdBottomSheet","$mdToast","reservationService","audioService","dataService","notificationService",function(a,b,d,e,f,g,h,i,j,k){function l(a){var b={};return angular.forEach(a,function(a,c){b[c]=a.reservationList}),b}function m(a){var b=l(a),c=0;return angular.forEach(b,function(a){a.forEach(function(a){c+=a.reservationStatus===j.reservationStatus.waitConfirm?1:0})}),c}function n(a){g.show(g.simple().content(a.msg).position("right bottom"))}function o(a){var b=m(a);b>0&&(k.create("预约消息",{body:"一共收到"+b+"条预约消息",icon:"img/ppz.jpg",tag:"tip"}).then(function(a){a.onclick=function(){a.close(),console.log("notification"),top.window.focus()}}),p||(p=i.create({src:"img/tip.ogg"})),p.play())}a.REQUEST_STATUS={INIT:0,REQUESTING:1,REQUEST_SUCCESSED:2,REQUEST_FAILED:3},a.KEY_CODE={ENTER:13,BACKSPACE:8,TOP:38,RIGHT:39,BOTTOM:40,LEFT:37},a.showCover=!1,a.alertType="alert-info",a.alertContent="",a.setAlert=function(b){a.showCover=b.showCover||!1,a.alertType=b.alertType||"alert-info",a.alertContent=b.alertContent||""},c.subscribe("businessError",n),c.subscribe("serverError",n),c.subscribe("businessSuccess",n),b.isLogined=function(){return!(!d.token||"null"===d.token)},b.$on("$locationChangeStart",function(a,c){b.isLogined()||/login/.test(c)||e.path("/login")}),b.showReservationList=function(){f.show({templateUrl:"partials/reservationToastList.html",controller:"reservationCtrl",locals:{queueMap:h.getQueueMap()}})};var p;a.$watch("disableReservationHint",function(a){a&&(h.close(),c.unSubscribe("newReservation",o))}),a.disableReservationHint||(c.subscribe("newReservation",o),b.isLogined()&&h.connect())}])});
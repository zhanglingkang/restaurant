/*! ppz_website 2015-01-12 6:55:00 PM */
"use strict";define(function(a){var b=a("app");a("./menu-service"),a("./menu-manager-directive"),a("./menu-category-controller"),a("./menu-item-controller"),b.controller("menuController",["$scope","menuService","$timeout",function(a,b,c){function d(b){return void(a.menu=b)}function e(){a.categoryForm={categoryName:"",categoryDescription:""}}a.adding=!1,a.importMenuFile=[],a.wantImport=!1,a.importStatus=a.REQUEST_STATUS.INIT,a.isExcel=function(){return/application\/.+office.+/.test(a.importMenuFile[0].type)},a.importMenu=function(){a.wantImport=!0,a.importMenuFile.length>0&&a.isExcel()&&(a.importStatus=a.REQUEST_STATUS.REQUESTING,b.importMenu(a.importMenuFile[0],a.restaurantId).then(function(){a.importStatus=a.REQUEST_STATUS.REQUEST_SUCCESSED},function(){a.importStatus=a.REQUEST_STATUS.REQUEST_FAILED}))},a.sortMenuCategoryStatus=a.REQUEST_STATUS.INIT,a.sortMenuCategory=function(c){var d=null,e=c.sortList;e.forEach(function(a,b){a.id===c.dragNodeId&&b>0&&(d=c.sortList[b-1].id)}),a.sortMenuCategoryStatus=a.REQUEST_STATUS.REQUESTING,a.setAlert({showCover:!0,alertContent:"排序中..."}),b.sortMenuCategory({categoryId:c.dragNodeId,previousCategoryId:d},a.menu.restaurantId).then(function(){a.sortMenuCategoryStatus=a.REQUEST_STATUS.REQUEST_SUCCESSED;var b=[];e.forEach(function(c){b.push(a.getMenuCategory(c.id))}),a.menu.menuCategories=b,a.setAlert({showCover:!1})},function(){a.sortMenuCategoryStatus=a.REQUEST_STATUS.REQUEST_FAILED,a.setAlert({showCover:!0,alertContent:"操作失败"})})},a.getMenuCategory=function(b){var c;return a.menu.menuCategories.some(function(a){return a.categoryId===b?(c=a,!0):void 0}),c},a.refreshMenu=function(){b.getMenu(a.restaurantId).then(function(a){d(a.results[0])},function(b){a.error=b})},a.refreshMenu(),a.collapseAll=function(b){a.$broadcast("collapse",b)},a.toAddMenuCategory=function(){a.adding=!0,a.addStatus=a.REQUEST_STATUS.INIT,e()},e(),a.addStatus=a.REQUEST_STATUS.INIT,a.addMenuCategory=function(){a.addStatus=a.REQUEST_STATUS.REQUESTING,b.addMenuCategory(a.categoryForm,a.menu.restaurantId).then(function(b){e(),a.addStatus=a.REQUEST_STATUS.REQUEST_SUCCESSED,a.menu.menuCategories=a.menu.menuCategories.concat(b.results),a.adding=!1},function(){a.addStatus=a.REQUEST_STATUS.REQUEST_FAILED})}}])});
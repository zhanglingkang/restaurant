/*! ppz_website 2015-02-05 3:20:31 PM */
!function(){var a=document.scripts[document.scripts.length-1].src.replace(/\/js\/.*/,"/js/");seajs.config({base:a,alias:{}})}(),define("app",[],function(){return angular.module("ppzRestaurant",["ngRoute","ngCookies","ngMaterial","ui.bootstrap","angularFileUpload"])}),define("index/controller",["app","public/general/util","public/general/pub-sub","public/local/reservation-service","public/general/audio-service","public/local/data-service","public/general/notification-service","./directive"],function(a){var b=a("app"),c=(a("public/general/util"),a("public/general/pub-sub"));a("public/local/reservation-service"),a("public/general/audio-service"),a("public/local/data-service"),a("public/general/notification-service"),a("./directive"),b.controller("appController",["$rootScope","$scope","$cookies","$location","$mdBottomSheet","$mdToast","reservationService","audioService","dataService","notificationService",function(a,b,d,e,f,g,h,i,j,k){function l(a){var b={};return angular.forEach(a,function(a,c){b[c]=a.reservationList}),b}function m(a){var b=l(a),c=0;return angular.forEach(b,function(a){a.forEach(function(a){c+=a.reservationStatus===j.reservationStatus.waitConfirm?1:0})}),c}function n(a){g.show(g.simple().content(a.msg).position("right bottom"))}function o(a){var b=m(a);b>0&&(k.create("预约消息",{body:"一共收到"+b+"条预约消息",icon:"img/ppz.jpg",tag:"tip"}).then(function(a){a.onclick=function(){a.close(),console.log("notification"),top.window.focus()}}),p||(p=i.create({src:"img/tip.ogg"})),p.play())}a.REQUEST_STATUS={INIT:0,ING:1,SUCCESSFUL:2,FAILED:3},a.KEY_CODE={ENTER:13,BACKSPACE:8,TOP:38,RIGHT:39,BOTTOM:40,LEFT:37},a.showCover=!1,a.alertType="alert-info",a.alertContent="",a.setAlert=function(b){a.showCover=b.showCover||!1,a.alertType=b.alertType||"alert-info",a.alertContent=b.alertContent||""},c.subscribe("businessError",n),c.subscribe("serverError",n),c.subscribe("businessSuccess",n),b.isLogined=function(){return!(!d.token||"null"===d.token)},b.$on("$locationChangeStart",function(a,c){b.isLogined()||/login/.test(c)||e.path("/login")}),b.showReservationList=function(){f.show({templateUrl:"partials/reservationToastList.html",controller:"reservationCtrl",locals:{queueMap:h.getQueueMap()}})};var p;a.$watch("disableReservationHint",function(a){a&&(h.close(),c.unSubscribe("newReservation",o))}),a.disableReservationHint||(c.subscribe("newReservation",o),b.isLogined()&&h.connect())}])}),define("index/directive",["app"],function(a){var b=a("app");b.directive("deleteDatePicker",[function(){return{restrict:"A",link:function(a){a.$on("$locationChangeStart",function(){$("body .datetimepicker").remove()})}}}])}),define("login/controller",["app","./service","public/local/reservation-service"],function(a){var b=a("app");a("./service"),a("public/local/reservation-service"),b.controller("loginController",["$scope","loginService","$window","$location","$cookies","reservationService",function(a,b,c,d,e,f){b.resetPassword=b.resetPassword.setRequestStatus(a,"resetStatus"),b.login=b.login.setRequestStatus(a,"loginStatus"),a.getUserName=function(){return e.username},a.resetPasswordForm={userName:""},a.submitted=!1,a.initResetInfo=function(){a.resetPasswordForm.userName="",a.resetStatus=a.REQUEST_STATUS.INIT,a.submitted=!1},a.resetStatus=a.REQUEST_STATUS.INIT,a.resetPassword=function(c){a.submitted=!0,c&&b.resetPassword(a.resetPasswordForm.userName).error(function(b){a.resetHint=b.message})},a.loginStatus=a.REQUEST_STATUS.INIT,a.performLogin=function(){a.loginHintShow=!0,b.login(a.username,a.password).then(function(a){console.log("login result "+a),console.log("token "+e.token),d.path("/myRestaurants"),f.connect()},function(a){console.log("login failed "+a)})},a.logout=function(){b.logout(function(){location.reload()})}}])}),define("login/service",["app"],function(a){var b=a("app");b.factory("loginService",["$http","$q","$window","$cookies","httpService",function(a,b,c,d,e){var f={login:function(a,b){return e.post({command:"login",data:{userId:a,password:b},includeSessionId:!1}).success(function(b){var c=b.results[0].sessionId;d.token=c,d.username=a}).error(function(){d.token=null})},logout:function(a){return e.post({command:"logout"}).success(function(){d.token=null,a()}).error(function(a){console.log("encounted error in getMyRestaurantList: "+a)})},resetPassword:function(a){return e.post({command:"requestUserPasswordReset",data:{userId:a}})}};return f}])}),define("main",["app","route"],function(a){{var b=a("app");a("route")}angular.bootstrap(document,[b.name])}),define("manage-account/controller",["app","./service"],function(a){var b=a("app");a("./service"),b.controller("manageAccountController",["$cookies","$scope","manageAccountService","httpService",function(a,b,c,d){c.modifyPassword=c.modifyPassword.setRequestStatus(b,"modifyPasswordStatus"),c.modifyEmail=c.modifyPassword.setRequestStatus(b,"modifyPasswordStatus"),b.submitted=!1,b.modifyPasswordForm={oldPassword:"",newPassword:"",againPassword:""},b.modifyPasswordStatus=b.REQUEST_STATUS.INIT,b.modifyPassword=function(a){b.submitted=!0,a&&b.modifyPasswordForm.newPassword===b.modifyPasswordForm.againPassword&&c.modifyPassword(b.modifyPasswordForm.oldPassword,b.modifyPasswordForm.newPassword).error(function(a){angular.isObject(a)&&a.code==d.PPZ_CODE.OLD_PASSWORD_ERROR&&(b.failHint="旧密码不正确")})},b.modifyEmailStatus=b.REQUEST_STATUS.INIT,b.wantModifyEmail=!1,b.modifyEmail=function(a){b.wantModifyEmail=!0,a&&c.modifyEmail(b.email).error(function(){b.modifyEmailHint="修改email失败"})},c.getUserInfo().then(function(a){b.email=a.results[0].email})}])}),define("manage-account/service",["app"],function(a){var b=a("app");b.service("manageAccountService",["$window","$cookies","httpService",function(a,b,c){var d,e=function(a){return c.post({command:"updateUserInfo",data:a})};return{modifyPassword:function(a,c){var d={sessionId:b.token,userId:b.username,password:c,oldPassword:a};return e(d)},modifyEmail:function(a){var c={sessionId:b.token,userId:b.username,email:a};return e(c)},getUserInfo:function(){return d||(d=c.post({command:"getUserInfo"}).error(function(){d=null})),d}}}])}),define("print-number/controller",["app"],function(a){var b=a("app");b.controller("printNumberController",["$scope","$window","$rootScope","$timeout",function(a,b,c,d){c.excludeHeader=!0,c.disableReservationHint=!0,a.partyTypeDescription=b.printPartyTypeDescription,a.unitId=b.printUnitId,d(function(){window.print()},.5)}])}),define("public-wait-list/controller",["app"],function(a){var b=a("app");b.controller("publicWaitListController",["$rootScope","$scope","$timeout","$window",function(a,b,c,d){function e(a){a=a||d.data,angular.forEach(a,function(a,c){b[c]=a})}d.addEventListener("message",function(a){var d=a.data.data;switch(a.data.type){case"initData":e(d);break;case"call":b.lastCalledNumbers[d.unitIdPrefix]=d.unit.unitId,b.panelTypes[d.unitIdPrefix]="panel-primary animate-flicker",console.time("flicker"),c(function(){console.timeEnd("flicker"),b.panelTypes[d.unitIdPrefix]="panel-primary"},1e4)}b.$apply()}),e(),a.excludeHeader=!0,a.disableReservationHint=!0,b.panelTypes={};for(var f=0;f<b.partyTypes.length;f++){var g=b.partyTypes[f];b.panelTypes[g.unitIdPrefix]="panel-info"}console.log(JSON.stringify(b.lastCalledNumbers))}])}),define("public/general/app-cache",[],function(){}),define("public/general/audio-service",["app"],function(a){var b=a("app"),c=["$document",function(){return{create:function(a){var b=new Audio;return a=a||{},angular.forEach(a,function(a,c){b[c]=a}),{play:function(){b.play()},pause:function(){b.pause()}}}}}];b.service("audioService",c)}),define("public/general/chinese-date",[],function(require,exports,module){function getChineseCalendar(a){return a=a||new Date,{chineseYear:getChineseYear(a),chineseMonth:getChineseMonth(a),chineseDay:getChineseDate(a),chineseSolarTerm:getSolarTerm(a),weekName:getWeekName(a)}}function getWeekName(a){var b=["周日","周一","周二","周三","周四","周五","周六"];return b[a.getDay()]}function getChineseDateNumber(a){function b(a){return parseInt((Date.parse(a)-Date.parse(a.getFullYear()+"/1/1"))/864e5)+1}{var c,d,e,f,g,h,i,j,k=[22,42,218,0,131,73,182,5,14,100,187,0,25,178,91,0,135,106,87,4,18,117,43,0,29,182,149,0,138,173,85,2,21,85,170,0,130,85,108,7,13,201,118,0,23,100,183,0,134,228,174,5,17,234,86,0,27,109,42,0,136,90,170,4,20,173,85,0,129,170,213,9,11,82,234,0,22,169,109,0,132,169,93,6,15,212,174,0,26,234,77,0,135,186,85,4],l=[],m=[],n=[],o=a.getFullYear();a.getMonth()+1,a.getDate()}if(100>o&&(o+=1900),1997>o||o>2020)return 0;for(n[0]=k[4*(o-1997)],n[1]=k[4*(o-1997)+1],n[2]=k[4*(o-1997)+2],n[3]=k[4*(o-1997)+3],l[0]=0!=(128&n[0])?12:11,c=127&n[0],f=n[1],f<<=8,f|=n[2],d=n[3],e=15;e>=0;e--)m[15-e]=29,0!=(1<<e&f)&&m[15-e]++,l[15-e]==d?l[15-e+1]=-d:(l[15-e+1]=l[15-e]<0?-l[15-e]+1:l[15-e]+1,l[15-e+1]>12&&(l[15-e+1]=1));if(g=b(a)-1,g<=m[0]-c)i=o>1901&&getChineseDateNumber(new Date(o-1+"/12/31"))<0?-l[0]:l[0],j=c+g;else{for(h=m[0]-c,e=1;g>h&&h+m[e]<g;)h+=m[e],e++;i=l[e],j=g-h}return i>0?100*i+j:100*i-j}function getChineseYear(a){function b(a){var b=["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"],c=new Array("子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥");return b[a%10]+c[a%12]}var c=a.getFullYear(),d=a.getMonth()+1,e=parseInt(Math.abs(getChineseDateNumber(a))/100);return 100>c&&(c+=1900),e>d&&c--,c-=1864,b(c)}function getChineseMonth(a){var b=["零","正","二","三","四","五","六","七","八","九","十","冬","腊"],c=parseInt(getChineseDateNumber(a)/100);return 0>c?"闰"+b[-c]:b[c]}function getChineseDate(a){var b=["零","初一","初二","初三","初四","初五","初六","初七","初八","初九","初十","十一","十二","十三","十四","十五","十六","十七","十八","十九","二十","廿一","廿二","廿三","廿四","廿五","廿六","廿七","廿八","廿九","三十"],c=Math.abs(getChineseDateNumber(a))%100;return b[c]}function getSolarTerm(a){var b=["小寒","大寒","立春","雨水","惊蛰","春分","清明","谷雨","立夏","小满","芒种","夏至","小暑","大暑","立秋","处暑","白露","秋分","寒露","霜降","立冬","小雪","大雪","冬至"],c=[1272060,1275495,1281180,1289445,1299225,1310355,1321560,1333035,1342770,1350855,1356420,1359045,1358580,1355055,1348695,1340040,1329630,1318455,1306935,1297380,1286865,1277730,1274550,1271556],d=31556926,e=new Date(1901);for(e.setTime(94712046e4);a.getFullYear()<e.getFullYear();)e.setTime(e.getTime()-1e3*d);for(;a.getFullYear()>e.getFullYear();)e.setTime(e.getTime()+1e3*d);for(var f=0;a.getMonth()>e.getMonth();f++)e.setTime(e.getTime()+1e3*c[f]);return a.getDate()>e.getDate()&&(e.setTime(e.getTime()+1e3*c[f]),f++),a.getDate()>e.getDate()&&(e.setTime(e.getTime()+1e3*c[f]),23==f?f=0:f++),a.getDate()==e.getDate()?b[f]:""}var dateProto={getChineseYear:getChineseYear.curryThis(),getChineseMonth:getChineseMonth.curryThis(),getChineseDate:getChineseDate.curryThis(),getSolarTerm:getSolarTerm.curryThis(),getWeekName:getWeekName.curryThis(),isToday:function(){return this.format("yyyy-MM-dd")===(new Date).format("yyyy-MM-dd")},isSameDay:function(a){return this.format("yyyy-MM-dd")===a.format("yyyy-MM-dd")},isBeforeToday:function(){return this.format("yyyy-MM-dd")<(new Date).format("yyyy-MM-dd")},isAfterToday:function(){return this.format("yyyy-MM-dd")>(new Date).format("yyyy-MM-dd")}};dateProto.__proto__=Date.prototype;var ChineseDate=function(){var newCode="new Date("+[].join.call(arguments,",")+")",date=eval(newCode);return date.__proto__=dateProto,date};ChineseDate.getCountOfMonth=function(a,b){var c=new Date(a,b-1,1),d=new Date(a,b,0),e=(d-c)/864e5+1;return e},module.exports=ChineseDate}),define("public/general/compute-position",[],function(){function a(a,d,e,f,g){e=e||"top",f=f||"parent",g=g||11;var h={left:0,top:0},i={width:d.getClientRects()[0].width,height:d.getClientRects()[0].height},j="parent"===f?c(d):b(d),k={width:a.getClientRects()[0].width,height:a.getClientRects()[0].height},l="parent"===f?d.offsetParent:document.documentElement,m={width:l.getClientRects()[0].width,height:l.getClientRects()[0].height};switch(e){case"top":h.left=j.left-(k.width-i.width)/2,h.top=j.top-k.height-g,h.left<0?(h.arrowPosition=.5-(0-h.left)/k.width,h.left=0):h.left+k.width>m.width&&(h.arrowPosition=.5+(h.left+k.width-m.width)/k.width,h.left=m.width-k.width);break;case"bottom":h.left=j.left-(k.width-i.width)/2,h.top=j.top+i.height+g;break;case"left":h.left=j.left-k.width-g,h.top=j.top-(k.height-i.height)/2;break;case"right":h.left=j.left+i.width+g,h.top=j.top-(k.height-i.height)/2}return{left:h.left+"px",top:h.top+"px",arrowPosition:100*h.arrowPosition+"%"}}function b(a){var b=a.getBoundingClientRect();return{top:window.pageYOffset+b.top,left:window.pageXOffset+b.left}}function c(a){var c=b(a),d=b(a.offsetParent);return{top:c.top-d.top,left:c.left-d.left}}return{getPosition:a,getSize:function(a){var b=a.getClientRects()[0];return{width:b.width,height:b.height}}}}),define("public/general/date-util",[],function(){return{parse:function(a){return a=a.replace(/-/g,"/"),new Date(a)}}}),define("public/general/directive/alert",["app","public/local/system"],function(a){var b=a("app"),c=a("public/local/system");b.directive("selfAlert",["$timeout",function(a){return{restrict:"E",replace:!0,transclude:!0,scope:{show:"=",showType:"=",noAutoHide:"="},templateUrl:c.getTplAbsolutePath("tpl/directive/alert.html"),link:function(b,c,d){var e=($(c),parseInt(d.showTime||0));b.hideAlert=function(){b.show=!1},b.$watch("show",function(){b.show&&!b.noAutoHide&&a(function(){b.show=!1},e||5e3)})}}}])}),define("public/general/directive/clear-img",["app"],function(a){var b=a("app");b.directive("clearImg",function(){return{restrict:"A",scope:{clear:"="},link:function(a,b){a.$watch("clear",function(){a.clear&&($(b)[0].src="",a.clear=!1)})}}})}),define("public/general/directive/confirm-hint",["app"],function(a){var b=a("app"),c=$("#modal-hint");c.modal({keyboard:!1,show:!1,backdrop:!1}),b.directive("confirmHint",function(){return{restrict:"A",link:function(a,b,d){function e(a){$.contains(c.find(".modal-footer")[0],a.target)||a.stopPropagation()}var f=$(b),g=!1;document.addEventListener("click",function(a){f[0]===a.target&&(g?g=!1:(a.stopPropagation(),c.find(".modal-title").html(d.modalTitle),c.find(".modal-body").html(d.modalContent),c.modal("show"),c.find(".confirm")[0].onclick=function(){g=!0,c.modal("hide"),a.target.click()}))},!0),c.on("show.bs.modal",function(){window.addEventListener("click",e,!0)}),c.on("hidden.bs.modal",function(){window.removeEventListener("click",e,!0)})}}})}),define("public/general/directive/date-picker",["app","public/local/system","public/general/util"],function(a){var b=a("app"),c=a("public/local/system"),d=a("public/general/util");b.directive("datePicker",function(){return{restrict:"E",replace:"true",scope:!0,templateUrl:c.getTplAbsolutePath("tpl/directive/date-picker.html"),compile:function(a,b){var c=$(a),e={};for(var f in b)b.hasOwnProperty(f)&&(f.match(/^ng/)||"required"===f||"name"===f||"placeholder"===f)&&(e[b.$attr[f]]=b[f]);return c.find("input").attr(e),function(a,b,c){$(b).attr("data-date",(new Date).toJSON().substring(0,10));var e=$(b).datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:c.startView||2,minView:c.minView||2,forceParse:0,showMeridian:1});$(".datetimepicker").find(".next").html('<i class="glyphicon glyphicon-arrow-right"></i>'),$(".datetimepicker").find(".prev").html('<i class="glyphicon glyphicon-arrow-left"></i>'),e.on("changeDate",function(){a.$parent.$apply(function(){d.setPropertyValue(a.$parent,c.ngModel,$(b).find("input").val())})})}}}})}),define("public/general/directive/directive",[],function(){}),define("public/general/directive/drag-sort",["app"],function(a){var b=a("app");b.directive("dragId",function(){return{restrict:"A",link:function(a,b){$(b).attr("draggable","true")}}}),b.directive("dragSort",function(){return{restrict:"A",scope:{dragCompleted:"="},link:function(a,b,c){function d(a){var b;return f.find(h).each(function(d,e){e.getAttribute(c.dragSort)===a.getAttribute(c.dragSort)&&(b=d+1)}),b}var e,f=$(b),g=-1,h=">["+c.dragSort+"]";f.on("dragstart",h,function(a){var b=a.originalEvent;e=a.currentTarget,g=d(e),$(e).addClass("moving"),b.dataTransfer.setData("text",""),b.dataTransfer.effectAllowed="move"}),f.on("dragover",h,function(a){var b;if(e){if(b=a.currentTarget,b===e)return;var c=2===e.compareDocumentPosition(b)?"before":"after";$(b)[c](e)}}),f.on("dragend",h,function(){var b=[];$(e).removeClass("moving"),(g!==d(e)||"forceRefresh"in c)&&(f.children().attr("data-remove",""),f.find(h).each(function(a,d){b.push({id:d.getAttribute(c.dragSort),sort:a+1})}),a.$apply(function(){a.dragCompleted({sortList:b,dragParam:c.dragParam,dragNodeId:e.getAttribute(c.dragSort)})})),e=null,g=-1})}}})}),define("public/general/directive/editor",["app","public/local/system","public/general/util","../jquery-plugin/editor","public/local/http"],function(a){function b(){var a=["Serif","Sans","Arial","Arial Black","Courier","Courier New","Comic Sans MS","Helvetica","Impact","Lucida Grande","Lucida Sans","Tahoma","Times","Times New Roman","Verdana"],b=$(".font-set").siblings(".dropdown-menu");$.each(a,function(a,c){b.append($('<li><a data-edit="fontName '+c+'" style="font-family:\''+c+"'\">"+c+"</a></li>"))}),$("a[title]").tooltip({container:"body"}),$(".dropdown-menu input").click(function(){return!1}).change(function(){$(this).parent(".dropdown-menu").siblings(".dropdown-toggle").dropdown("toggle")}).keydown("esc",function(){this.value="",$(this).change()}),$("[data-role=magic-overlay]").each(function(){var a=$(this),b=$(a.data("target"));a.css("opacity",0).css("position","absolute").offset(b.offset()).width(b.outerWidth()).height(b.outerHeight())})}var c=a("app"),d=a("public/local/system"),e=a("public/general/util");a("../jquery-plugin/editor"),a("public/local/http"),c.directive("editor",["$compile","httpService",function(a,c){return{restrict:"E",replace:!0,scope:!0,templateUrl:d.getTplAbsolutePath("tpl/directive/editor.html"),compile:function(a,d){var f=$(a),g=function(a,d,g){var h=f.find("#editor");b(),h.wysiwyg(),h.on("fileSelected",function(a,b){var d=b[0];d&&/image/.test(d.type)&&c.post({r:"index/imageUpload",data:{up_file:b[0]},success:function(a){h.trigger("fileUploaded",[a.image_url])}})}),h.on("editorContentChanged",function(b,c){a.$parent.$apply(function(){f.find("textarea").html(c),e.setPropertyValue(a.$parent,g.ngModel,c)})}),a.$parent.$watch(g.ngModel,function(){var b=h.cleanHtml(),c=e.getPropertyValue(a.$parent,g.ngModel);c!==b&&h.html(c)})},h={};for(var i in d)d.hasOwnProperty(i)&&(i.match(/^ng/)||"required"===i||"name"===i)&&(h[d.$attr[i]]=d[i]);return f.find("textarea").attr(h),g}}}])}),define("public/general/directive/file-model",["app"],function(a){var b=a("app");b.directive("fileModel",function(){return{restrict:"A",link:function(a,b,c){var d=$(b);d.bind("change",function(){a.$apply(function(){a[c.fileModel]=d[0].files})})}}})}),define("public/general/directive/file-required",["app","public/general/form-validation"],function(a){var b=a("app"),c=a("public/general/form-validation");b.directive("fileRequired",function(){return{restrict:"A",link:function(a,b){var d=$(b),e=angular.element(b).parent("form").scope(),f=d.parents("form").attr("name"),g=d.attr("name"),h=e[f][g],i=h.$error;i.required=!0,c.setFieldValidation(h),c.setFormValidataion(e[f]),d.bind("change",function(){var a=d[0].files[0];e.$apply(function(){e[f][g].$error.required=a?!1:!0,c.setFieldValidation(h),c.setFormValidataion(e[f])})})}}})}),define("public/general/directive/file-type",["app","public/general/form-validation"],function(a){var b=a("app"),c=a("public/general/form-validation");b.directive("fileType",function(){return{restrict:"A",link:function(a,b,d){var e=$(b),f=angular.element(b).parent("form").scope(),g=e.parents("form").attr("name"),h=e.attr("name"),i=f[g][h],j=i.$error;e.bind("change",function(){var a=e[0].files[0];f.$apply(function(){j.fileType=a&&-1===a.type.indexOf(d.fileType)?!0:!1,c.setFieldValidation(i),c.setFormValidataion(f[g])})})}}})}),define("public/general/directive/form-reset",["app"],function(a){var b=a("app");b.directive("formReset",function(){return{restrict:"A",scope:{reset:"="},link:function(a,b){a.$watch("reset",function(){a.reset&&($(b)[0].reset(),a.reset=!1,a.$emit("formReseted"))})}}})}),define("public/general/directive/full-tr",["app"],function(a){var b=a("app");b.directive("fullTr",function(){return{restrict:"A",link:function(a,b){var c=$(b),d=c.parents("table").find("thead tr:nth-child(1)").find(">td,>th");0===d.length&&(d=c.parents("table").find("tr:nth-child(1)").find(">td,>th"));var e=0;d.each(function(a,b){e+=parseInt($(b).attr("colspan")||1)}),c.attr("colspan",e)}}})}),define("public/general/directive/img-size",["app","public/general/form-validation"],function(a){var b=a("app"),c=a("public/general/form-validation");b.directive("imgSize",function(){return{restrict:"A",link:function(a,b,d){{var e=$(b),f=angular.element(b).parent("form").scope(),g=e.parents("form").prop("name"),h=e.prop("name"),i=f[g][h];i.$error}e.bind("change",function(){function a(){var a=b+"*"+j;f.$apply(function(){f[g][h].$error.imgSize=a!==d.imgSize.trim()?!0:!1,c.setFieldValidation(i),c.setFormValidataion(f[g])})}var b,j,k=e[0].files[0];if(k&&-1!=k.type.indexOf("image")){var l=new Image,m=new FileReader;l.onload=function(){b=l.naturalWidth,j=l.naturalHeight,a()},m.addEventListener("load",function(a){l.src=a.target.result}),m.readAsDataURL(k)}else f.$apply(function(){f[g][h].$error.imgSize=!1,c.setFieldValidation(i),c.setFormValidataion(f[g])})})}}})}),define("public/general/directive/ng-model",["app","public/general/util"],function(a){var b=a("app"),c=a("public/general/util");b.directive("ngModel",function(){return{restrict:"A",link:function(a,b,d){var e=$(b);"INPUT"===e[0].nodeName&&"file"===e.attr("type")&&e.bind("change",function(){a.$apply(function(){var b=e[0].multiple?e[0].files:e[0].files[0];c.setPropertyValue(a,d.ngModel,b)})})}}})}),define("public/general/directive/pagination",["app","public/local/system","public/local/http"],function(a){var b=a("app"),c=a("public/local/system");a("public/local/http"),b.directive("selfPagination",["httpService",function(a){return{restrict:"E",replace:!0,templateUrl:c.getTplAbsolutePath("tpl/directive/pagination.html"),scope:{paginationScope:"="},link:function(b,c){function d(a){b.searchResult=a,b.searchResult.pageCount=parseInt((parseInt(a.count)+a.pageSize-1)/a.pageSize),b.searchResult.pageInfo=e(b.searchResult.pageCount,a.page),angular.forEach(a,function(a){angular.isArray(a)&&a.forEach(function(a,c){a.order=b.searchResult.pageSize*b.searchResult.page-b.searchResult.pageSize+1+c})})}function e(a,b){var c=b-5;1>c&&(c=1);for(var d=[],e=0;10>e&&a>=c+e;++e)d.push(c+e);return{pageRange:d,last:1==b?!1:b-1,next:b==a?!1:b+1}}$(c);b.paginationScope=b,b.goPage=function(c){c!==!1&&(void 0===c?b.searchForm.page=b.searchForm.page||1:c&&(b.searchForm.page=c),b.$emit("searchStart"),a.get({r:b.searchInterface,data:b.searchForm,success:function(a){d(a),b.$emit("searchEnd",a)},error:function(a){b.$emit("searchFail",a)}}))},b.autoSearch&&(b.goPage=1)}}}])}),define("public/general/directive/popover",["app","public/general/util","public/general/compute-position"],function(a){var b=a("app"),c=a("public/general/util"),d=a("public/general/compute-position");b.directive("selfPopover",["$compile",function(a){return{restrict:"E",terminal:!0,scope:!0,link:function(b,e,f){function g(){l=new MutationObserver(function(){$.contains(document.body,n[0])||(j&&j.remove(),l.disconnect())});var a;a="observeContext"in f?$(f.observeContext)[0]:n[0].parentNode,l.observe(a,{childList:!0,subtree:!0})}function h(a){if(!$.contains(document.body,j[0])||!$.contains(document.body,n[0]))return void document.removeEventListener("click",h,!0);var b=n.data("bs.popover").$tip[0];if(b&&!$.contains(b,a.target))if(f.exclude){var c=!1;$(f.exclude).each(function(b,d){$.contains(d,a.target)&&(c=!0)}),c||n.popover("hide")}else n.popover("hide");($.contains(n[0],a.target)||n[0]===a.target)&&a.stopPropagation()}function i(){var a=d.getPosition(n.data("bs.popover").$tip[0],n[0],f.placement,f.container,1);n.data("bs.popover").$tip.css({left:a.left,top:a.top}),a.arrowPosition&&("top"===f.placement||"bottom"===f.placement)&&n.data("bs.popover").$tip.find(".arrow").css({left:a.arrowPosition}),n.data("bs.popover").$tip.removeClass("popover-hidden"),i.last={width:d.getSize(n.data("bs.popover").$tip[0]).width,height:d.getSize(n.data("bs.popover").$tip[0]).height}}var j,k,l,m=$(e),n=m.parent(),o=f.style||"",p='<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content" ></div></div>';p=p.replace(/(?=class=['"]popover-content['"])/,"style='"+o+"' "),b.close=!1,b.$watch("close",function(){b.close&&(n.popover("hide"),b.close=!1)}),f.relatedTarget&&(n="parent"===f.context?m.parent().find(f.relatedTarget):$(f.relatedTarget)),f.placement=f.placement||"top",m.children().addClass("ng-cloak"),m.remove(),n.attr("data-toggle","popover"),n.popover({html:!0,content:m.html(),container:f.container,placement:f.placement,template:p}),n.on("show.bs.popover",function(){j=n.data("bs.popover").$tip,n.data("bs.popover").$tip.addClass(f.class),n.data("bs.popover").$tip.addClass("popover-hidden")}),n.on("shown.bs.popover",function(){var c=n.data("bs.popover").$tip.find(".popover-content");a(c.children())(b.$parent),"autoClose"in f&&document.addEventListener("click",h,!0),setTimeout(function(){i()},0),"needObserve"in f&&g(),"watchSize"in f&&(k=setInterval(function(){if(!$.contains(document.body,j[0])||!$.contains(document.body,n[0]))return void clearInterval(k);var a=d.getSize(j[0]);(a.width!==i.last.width||a.height!==i.last.height)&&i()},100)),b.$apply()}),n.on("hidden.bs.popover",function(){document.removeEventListener("click",h,!0),clearInterval(k),l&&l.disconnect()}),b.$on("closePopover",function(a,b){b===f.name&&n.popover("hide")});var q={close:function(){b.close=!0}};if("name"in f){var r=f.name;"object"in f&&(r=f.object+"."+f.name),c.setPropertyValue(b.$parent,r,q)}}}}])}),define("public/general/directive/prevent-spread",["app"],function(a){var b=a("app");b.directive("preventSpread",function(){return{restrict:"A",link:function(a,b,c){var d=$(b);d.bind(c.preventSpread,function(a){a.stopPropagation()})}}})}),define("public/general/directive/preview-img",["app","public/local/system"],function(a){{var b=a("app");a("public/local/system")}b.directive("previewImg",function(){return{restrict:"A",link:function(a,b,c){var d=$(b),e=$(c.previewImg);d.bind("change",function(){var a=d.prop("files")[0];if(a&&-1!==a.type.indexOf("image")){var b=new FileReader;b.addEventListener("load",function(a){e.prop("src",a.target.result)}),b.readAsDataURL(a)}else e.prop("src","")})}}})}),define("public/general/directive/set-file",["app","public/general/util","public/local/system"],function(a){{var b=a("app"),c=a("public/general/util");a("public/local/system")}b.directive("setFile",function(){return{restrict:"A",link:function(a,b,d){var e=$(b);e.bind("change",function(){c.setPropertyValue(a,d.setFile,e[0].files)})}}})}),define("public/general/directive/smart-float",["app"],function(a){var b=a("app"),c=/^\-?\d+((\.|\,)\d+)?$/;b.directive("smartFloat",function(){return{require:"ngModel",link:function(a,b,d,e){e.$parsers.unshift(function(a){return c.test(a)?(e.$setValidity("float",!0),parseFloat(a.replace(",","."))):void e.$setValidity("float",!1)})}}})}),define("public/general/directive/submitting",["app"],function(a){var b=a("app");b.directive("submitting",function(){return{restrict:"A",scope:{isSubmitting:"="},link:function(a,b,c){var d,e=$(b),f=c.submitting||"提交中...",g=e.val()||e.html();"BUTTON"===e[0].nodeName?d="html":"INPUT"===e[0].nodeName&&(d="val"),a.$watch("isSubmitting",function(){a.isSubmitting?(e[d](f),e.attr("disabled","disabled")):(e[d](g),e.removeAttr("disabled"))})}}})}),define("public/general/directive/table-scroll",["app","../jquery-plugin/scroll"],function(a){var b=a("app");a("../jquery-plugin/scroll"),b.directive("tableScroll",function(){return{restrict:"A",link:function(a,b,c){var d,e,f=$(b);c.td&&(d=parseInt(c.td),f.scrollHorizontal(function(){var a=f[0].scrollLeft;f.find("table tr.no-scroll").each(function(){for(var b=0;d>b;++b)$(this).find("td:nth-child("+(b+1)+")").each(function(){$(this).css({transform:$(this)[0].style.transform.replace(/translateX\(.*?\)/g,"")+" translateX("+a+"px)",position:"relative"}),0===a?$(this).removeClass("horizontal-fix"):$(this).addClass("horizontal-fix")})})})),c.tr&&(e=parseInt(c.tr),f.scrollVertical(function(){var a=f[0].getBoundingClientRect().top,b=f.find("table")[0].getBoundingClientRect().top,c=a-b;f.find("tr").each(function(a){return a===e?!1:void $(this).find("td").each(function(){$(this).css({transform:$(this)[0].style.transform.replace(/translateY\(.*?\)/g,"")+" translateY("+c+"px)",position:"relative"}),0===c?$(this).removeClass("vertical-fix"):$(this).addClass("vertical-fix")})})}))}}})}),define("public/general/directive/tooltip",["app"],function(a){var b=a("app");b.directive("tooltip",function(){return{restrict:"A",link:function(a,b,c){var d=$(b),e=c.tooltip||30,f=new MutationObserver(function(){var a=d.html().trim();a.replace(/\.\.\.$/,"").length>e&&d.html(a.substring(0,e)+"...")});f.observe(d[0].childNodes[0],{characterData:!0}),d.tooltip({delay:{show:0,hide:0}})}}})}),define("public/general/directive/trigger-click",["app"],function(a){var b=a("app");b.directive("triggerClick",function(){return{restrict:"A",link:function(a,b,c){var d=$(b);d.bind("click",function(){$(c.triggerClick).click()})}}})}),define("public/general/directive/view-img",["app"],function(a){var b=a("app"),c=$("#modal-view-img");c.modal({show:!1}),b.directive("viewImg",function(){return{restrict:"A",link:function(a,b,d){var e=$(b);e.bind("click",function(){e.attr("src")&&(c.find(".modal-title").html(d.imgTitle),c.find(".modal-body img").attr("src",e.attr("src")),c.modal("show"))})}}})}),define("public/general/filter/width",["app"],function(a){var b=a("app");b.filter("width",function(){return function(a,b,c,d){c=c||" ",void 0===d&&(d=!0);var e=[];return a.length<b&&(e.length=b-a.length+1,a=d?a+e.join(c):e.join(c)+a),console.log(a,"char",c),a}})}),define("public/general/form-validation",[],function(){return{setFieldValidation:function(a){a.$valid=!0,a.$invalid=!1;for(var b in a.$error)a.$error.hasOwnProperty(b)&&a.$error[b]&&(a.$valid=!1,a.$invalid=!0)},setFormValidataion:function(a){a.$valid=!0,a.$invalid=!1;for(var b in a)a.hasOwnProperty(b)&&"$"!==b.substring(0,1)&&a[b].$invalid&&(a.$valid=!1,a.$invalid=!0)}}}),define("public/general/jquery-plugin/editor",[],function(){!function(a){function b(a){return a=a.trim(),a&&(a=a.replace(/<div/g,"<p").replace(/<\/div>/g,"</p>"),a=a.replace(/<(\/)?br>/g,""),a=a.replace(/\u200b/g,""),a=a.replace(/<p>\s*<\/p>/g,""),a=a.replace(/class=['"]info-center['"]/g,""),a=a.replace(/<p((.(?!<p|class=|<\/p))*)(?=<img|<iframe)/g,"<p class='info-center' $1"),a&&!/^<p/.test(a)&&(a=a.replace(/<p/,"</p><p"),a="<p>"+a,/<\/p>/.test(a)||(a+="</p>")),a=a.replace(/(<iframe[^>]*src=['"])http:\/\/player.youku.com\/embed\/(.+)(['"][^>]*>)/g,"$1http://pic.wanmeiyueyu.com/upload/youkukilledrelate.html#$2$3")),a}a.fn.cleanHtml=function(){return b(a(this).hasClass("source-mode")?a(this).text():a(this).html())},a.fn.wysiwyg=function(c){var d,e,f,g=this,h=function(){e.activeToolbarClass&&a(e.toolbarSelector).find(f).each(function(){var b=a(this).data(e.commandRole);document.queryCommandState(b)?a(this).addClass(e.activeToolbarClass):a(this).removeClass(e.activeToolbarClass)})},i=function(a,b){var c=a.split(" "),d=c.shift(),e=c.join(" ")+(b||""),f=document.execCommand(d,0,e);return h(),f},j=function(b){a.each(b,function(a,b){g.keydown(a,function(a){g.attr("contenteditable")&&g.is(":visible")&&(a.preventDefault(),a.stopPropagation(),i(b))}).keyup(a,function(a){g.attr("contenteditable")&&g.is(":visible")&&(a.preventDefault(),a.stopPropagation())})})},k=function(){var a=window.getSelection();return a.getRangeAt&&a.rangeCount?a.getRangeAt(0):void 0},l=function(){d=k()},m=function(){var a=window.getSelection();if(d){try{a.removeAllRanges()}catch(b){document.body.createTextRange().select(),document.selection.empty()
}a.addRange(d)}},n=function(a){g.focus(),i("inserthtml","<p><img src='"+a+"' /></p>")},o=function(a,b){m(),document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",0,b||"transparent"),l(),a.data(e.selectionMarker,b)},p=function(c,d){function e(){""===g.html().replace(/\s+/g,"")&&i("insertHtml","<p>&#8203;</p>")}c.find(f).click(function(){m(),g.focus(),i(a(this).data(d.commandRole)),l()}),c.find("[data-toggle=dropdown]").click(m),c.find("input[type=text][data-"+d.commandRole+"]").on("webkitspeechchange change",function(){var b=this.value;this.value="",m(),b&&(g.focus(),i(a(this).data(d.commandRole),b)),l()}).on("focus",function(){var b=a(this);b.data(d.selectionMarker)||(o(b,d.selectionColor),b.focus())}).on("blur",function(){var b=a(this);b.data(d.selectionMarker)&&o(b,!1)}),c.find("input[type=file][data-"+d.commandRole+"]").change(function(){m(),"file"===this.type&&this.files&&this.files.length>0&&g.trigger("fileSelected",[this.files]),l(),this.value=""}),g.on("fileUploaded",function(a,b){n(b)}),c.find("[data-operation='full-screen']").on("click",function(){a("#editor-zone").toggleClass("full-screen"),a("body").css(a("#editor-zone").hasClass("full-screen")?{overflow:"hidden"}:{overflow:""})}),c.find("[data-operation=source-mode]").on("click",function(){g.toggleClass("source-mode");var d,e=/</g,h=/>/g;g.hasClass("source-mode")?(a(this).attr("data-original-title","源码模式"),c.find(f).addClass("disabled"),c.find("[data-toggle],#pictureBtn").addClass("disabled"),c.find("[type=file]").attr("disabled",""),d=b(g.html()),d=d.replace(/&/g,"&amp;"),d=d.replace(/(<p[^>]*>)/g,"$1&nbsp;&nbsp;"),d=d.replace(e,"<br/>&lt;").replace(h,"&gt;<br/>"),g.focus(),g.html(""),i("insertHtml",d)):(a(this).attr("data-original-title","编辑模式"),c.find(f).removeClass("disabled"),c.find("[data-toggle],#pictureBtn,[type=file]").removeClass("disabled"),c.find("[type=file]").removeAttr("disabled"),d=g.text(),d=d.replace(/[\u00a0\u0020\u0009]+/g," "),d=d.replace(/>[\u00a0\u0020\u0009]{1,2}/g,">"),g.focus(),g.html(""),i("insertHtml",d))}),function(){var a=new MutationObserver(function(){e(),g.trigger("editorContentChanged",[g.cleanHtml()])}),b={subtree:!0,characterData:!0,childList:!0,attributes:!0};a.observe(g[0],b)}(),g.bind("keypress",function(){e()})},q=function(){g.on("dragenter dragover",!1).on("drop",function(a){var b=a.originalEvent.dataTransfer;a.stopPropagation(),a.preventDefault(),b&&b.files&&b.files.length>0&&n(b.files)})};return e=a.extend({},a.fn.wysiwyg.defaults,c),f="a[data-"+e.commandRole+"],button[data-"+e.commandRole+"],input[type=button][data-"+e.commandRole+"]",j(e.hotKeys),e.dragAndDropImages&&q(),p(a(e.toolbarSelector),e),g.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){l(),h()}),a(window).bind("touchend",function(a){var b=g.is(a.target)||g.has(a.target).length>0,c=k(),d=c&&c.startContainer===c.endContainer&&c.startOffset===c.endOffset;(!d||b)&&(l(),h())}),this},a.fn.wysiwyg.defaults={hotKeys:{"ctrl+b meta+b":"bold","ctrl+i meta+i":"italic","ctrl+u meta+u":"underline","ctrl+z meta+z":"undo","ctrl+y meta+y meta+shift+z":"redo","ctrl+l meta+l":"justifyleft","ctrl+r meta+r":"justifyright","ctrl+e meta+e":"justifycenter","ctrl+j meta+j":"justifyfull","shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,fileUploadError:function(a,b){console.log("File upload error",a,b)}}}(window.jQuery)}),define("public/general/jquery-plugin/scroll",[],function(){$.fn.scrollHorizontal=function(a){var b=this;b[0].lastScrollLeft=b[0].scrollLeft,b.scroll(function(){b[0].scrollLeft!==b[0].lastScrollLeft&&(b[0].lastScrollLeft=b[0].scrollLeft,a())})},$.fn.scrollVertical=function(a){var b=this;b[0].lastScrollTop=b[0].scrollTop,b.scroll(function(){b[0].scrollTop!==b[0].lastScrollTop&&(b[0].lastScrollTop=b[0].scrollTop,a())})}}),define("public/general/notification-service",["app"],function(a){var b=a("app"),c=["$q",function(a){return{create:function(b,c){var d=a.defer();return"granted"===Notification.permission?d.resolve(new Notification(b,c)):"denied"!==Notification.permission&&(Notification.requestPermissioning||(Notification.requestPermissioning=!0,Notification.requestPermission(function(a){Notification.requestPermissioning=!1,"permission"in Notification||(Notification.permission=a),"granted"===Notification.permission?d.resolve(new Notification(b,c)):d.reject("权限不足")}))),d.promise}}}];b.service("notificationService",c)}),define("public/general/prototype",[],function(){Function.prototype.curryThis=function(){var a=this;return function(){return[].unshift.call(arguments,this),a.apply(null,arguments)}},Function.prototype.unCurryThis=function(){var a=this;return function(){return a.apply(arguments[0],arguments.slice(1))}},Function.prototype.before=function(a,b){return function(){if(b.apply(this,arguments))var c=a.apply(this,arguments);return c}}.curryThis(),Function.prototype.after=function(a,b){return function(){var c=a.apply(this,arguments);return b.lastResult=c,b.apply(this,arguments),c}}.curryThis(),Function.prototype.setRequestStatus=function(a,b,c){return a.before(function(){return b[c]=b.REQUEST_STATUS.ING,!0}).after(function d(){return d.lastResult.then(function(){b[c]=b.REQUEST_STATUS.SUCCESSFUL},function(){b[c]=b.REQUEST_STATUS.FAILED}),arguments[arguments.length-1]})}.curryThis(),Date.prototype.toString=function(){return this.format("yyyy-MM-dd")},Date.prototype.format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a}}),define("public/general/pub-sub",[],function(){var a={},b={};return{publish:function(c,d){a[c]=d,b[c]=b[c]||[],b[c].forEach(function(a){a(d)})},subscribe:function(a,c){b[a]=b[a]||[],b[a].push(c)},unSubscribe:function(a,c){b[a]=b[a]||[],b[a]=b[a].filter(function(a){return a!==c})}}}),define("public/general/speech-service",["app"],function(a){var b=a("app"),c=["$q",function(a){return{getVoices:function(){var b=a.defer(),c=speechSynthesis.getVoices();if(0===c.length)var d=setInterval(function(){c=speechSynthesis.getVoices(),0!==c.length&&(clearInterval(d),b.resolve(c))},0);else b.resolve(c);return b.promise},createMsg:function(a){return new SpeechSynthesisUtterance(a)},getNativeVoice:function(){return this.getVoices().then(function(a){var b;return a.some(function(a){return"native"===a.name||a.localService===!0?(b=a,!0):void 0}),b})},speak:function(a){a.voice||this.getNativeVoice().then(function(b){a.voice=b,console.log("voice:",b),speechSynthesis.speak(a),a.onstart=function(){console.log("speech:start",a)},a.onend=function(){console.log("speech:end",a)}})}}}];b.service("speechService",c)}),define("public/general/storage",[],function(){return{store:function(a,b){var c=JSON.stringify(b);sessionStorage.setItem(a,c)},remove:function(a){sessionStorage.removeItem(a)},has:function(a){return!!sessionStorage.getItem(a)},get:function(a){var b=sessionStorage.getItem(a);return JSON.parse(b)}}}),define("public/general/util",[],function(){return{isExcel:function(a){return a?/application\/.*(?:office|excel).*/.test(a.type):void 0},getArray:function(a){var b=[];return angular.forEach(a,function(a){b.push(a)}),b},serialize:function(a){var b="",c="";a=a||{};for(var d in a)a.hasOwnProperty(d)&&(b?c="&":b="",b+=c+d+"="+a[d]);return b},getUrl:function(a,b){var c=this.serialize(b);return c&&(-1===a.indexOf("?")&&(a+="?"),"?"!=a.charAt(a.length-1)&&(a+="&"),a+=c),a},clone:function(a){return JSON.parse(JSON.stringify(a))},setPropertyValue:function(a,b,c){var d,e=b.split(".");e.forEach(function(b,c){c<e.length-1&&(a=a[b])}),d=e.pop(),a[d]=c},getPropertyValue:function(a,b){var c,d=b.split(".");return d.forEach(function(b,c){c<d.length-1&&(a=a[b])}),c=d.pop(),a[c]}}}),define("public/local/confirmation-modal-controller",["app"],function(a){var b=a("app"),c=function(a,b,c){a.unit=c,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}};b.controller("confirmationModalController",c)}),define("public/local/data-service",["app"],function(a){var b=a("app"),c=[function(){var a={reservationStatus:{waitConfirm:1,accept:2,refuse:3},queueType:{wait:1,reserveParty:2,reserveRoom:3}},b={getText:function(a){var b;return util.getArray(this).some(function(c){return c.value===a?(b=c.text,!0):void 0}),b}};return angular.forEach(a,function(a){a.__proto__=b}),a}];b.service("dataService",c)}),define("public/local/http",["app","public/general/util","./system","public/general/pub-sub"],function(a){function b(a,b){return{data:JSON.stringify({command:a,inputs:b}),hash:"pleasedonotcheckmyhashthankyou!!"}}var c="//awsjp.ppzapp.com:34952",c="//ali.ppzapp.cn:34952",d=c+"/BBQueue/API",e=c+"/BBQueue/CredentialService",f=c+"/FileUploader/upload",g=c+"/FileUploader/menuUpload",h={SUCCESS:0,USER_NOT_FOUND:14,SESSION_TIMEOUT:16,LOGIN_FAIL:17,PERMISSION_DENIED:18,OLD_PASSWORD_ERROR:24},i=a("app"),j=(a("public/general/util"),a("./system"),a("public/general/pub-sub"));i.service("httpService",["$http","$rootScope","$q","$location","$cookies",function(a,c,i,k,l){return{SERVER_URL:d,AUTH_SERVER_URL:e,FILE_SERVER_URL:f,MENU_IMPORT_URL:g,PPZ_CODE:h,post:function(c){var e=i.defer(),g=new FormData,m=c.config||{};if(c.data=c.data||{},c.includeSessionId=c.includeSessionId===!1?!1:!0,c.includeSessionId&&(c.data.sessionId=l.token),c.isForm){angular.extend(m,{transformRequest:angular.identity,headers:{"Content-Type":void 0}});for(var n in c.data)g.append(n,c.data[n]);c.data=g}else c.data=b(c.command,c.data);return c.url=c.url||c.isForm?f:d,a(angular.extend(m,{method:"POST",url:c.url,data:c.data})).success(function(a,b,c,d){if(angular.isObject(a)){var f=JSON.parse(a.data);f.code==h.SUCCESS?e.resolve(f):(e.reject(f),f.code==h.SESSION_TIMEOUT?(delete l.token,delete l.username,k.path("/login")):f.code==h.PERMISSION_DENIED?j.publish("businessError",{msg:"权限不足"}):j.publish("businessError",{msg:f.message}))}else j.publish("jsonError",{status:b,response:a,url:d.command}),e.reject(f)}).error(function(a,b,c,d){j.publish("serverError",{msg:"服务器出错了！，命令："+d.data.command+",响应码:"+b}),e.reject(a)}),e.promise.success=function(a){return e.promise.then(a),e.promise},e.promise.error=function(a){return e.promise.then(null,a),e.promise},e.promise}}}])}),define("public/local/reservation-controller",["app"],function(a){var b=a("app"),c=["$scope","reservationService","dataService","$location","$mdBottomSheet","restaurantService","queueMap",function(a,b,c,d,e,f,g){a.reservationMap=[],a.restaurantList=[],angular.forEach(g,function(b,d){f.getRestaurant(d).then(function(b){a.restaurantList.push(b)}),a.reservationMap[d]=b.reservationList.filter(function(a){return a.reservationStatus===c.reservationStatus.waitConfirm})}),a.viewReservationDetail=function(a){d.path("/waitinglist/"+a.restaurantId),e.hide()}}];b.controller("reservationCtrl",c)}),define("public/local/reservation-service",["app","public/general/util","public/general/pub-sub"],function(a){var b=a("app"),c=a("public/general/util"),d=a("public/general/pub-sub"),e=["httpService","$cookies","$mdBottomSheet",function(a,b){function e(a,b){var c={};return a.forEach(function(a){c[a.createTime]=a}),!!c[b.createTime]}function f(a,b){return a.createTime===b.createTime}var g,h={};return h.__proto__={addQueue:function(a,b){function c(a,b){b.forEach(function(b){e(a,b)?a.forEach(function(c,d){f(b,c)&&(a[d]=b)}):a.push(b)})}return h[a]?(c(h[a].reservationList,b.reservationList),angular.forEach(h[a].waitingList,function(d,e){c(h[a].waitingList[e],b.waitingList[e])}),void c(h[a].completeList,b.completeList)):void(h[a]=b)}},{connect:function(){g&&g.readyState!==EventSource.CLOSED||(g=new EventSource(c.getUrl("/bbqueue",{command:"pullQueueUnit",sessionId:b.token})),g.addEventListener("open",function(){console.log("open:"+new Date)}),g.addEventListener("error",function(){console.log("error:"+new Date)}),g.addEventListener("message",function(a){var b=JSON.parse(a.data);h.addQueue(b.restaurantId,b.queues),d.publish("newReservation",h),console.log("message:")}))},close:function(){g&&g.close()},getQueueMap:function(){return h},getQueue:function(a){return h[a]},accept:function(a){return this.acceptOrDeclineReservation(angular.extend({accept:!0},a))},refuse:function(a){return this.acceptOrDeclineReservation(angular.extend({accept:!1},a))},acceptOrDeclineReservation:function(b){return a.post({command:"acceptOrDeclineReservation",data:b})}}}];b.service("reservationService",e)}),define("public/local/restaurant-service",["app"],function(a){var b=a("app");b.service("restaurantService",["$http","$window","$q","$cookies","httpService",function(a,b,c,d,e){var f;return{getMyRestaurantList:function(){return f||(f=e.post({command:"getManagingRestaurants"}),f.then(function(){},function(a){console.log("businessError:getManagingRestaurants: "+a),f=null})),f},resetWaitingList:function(a){return e.post({command:"resetWaitingList",data:{restaurantId:a}})},getRestaurant:function(a){var b=c.defer();return this.getMyRestaurantList().then(function(c){for(var d=0;d<c.results.length;++d)if(c.results[d].restaurantId===a){b.resolve(c.results[d]);break}d==c.results.length&&b.reject("没找到对应餐厅")},function(a){b.reject(a)}),b.promise},acceptReservation:function(a,b){return e.post({command:"modifyRestaurantInfo",data:{restaurantId:a,acceptReservation:b}})},enableQueue:function(a,b){return e.post({command:"modifyRestaurantInfo",data:{restaurantId:a,enableQueue:b}})},setMaxQueue:function(a,b){return e.post({command:"modifyRestaurantInfo",data:{restaurantId:a,maxQueueLength:b}})},updateRestaurantInfo:function(a,b){return e.post({command:"modifyRestaurantInfo",data:{restaurantId:a,"phone.number":b.phone.phone,email:b.email,website:b.website,restaurantDescription:b.restaurantDescription,"address.city":b.address.city,"address.location":b.address.location,"address.state":b.address.state,"address.street":b.address.street,"address.zipcode":b.address.zipcode}})},getWaitingList:function(a,b){return e.post({command:"allUnitInfo",data:{restaurantId:a}}).success(function(a){b(null,a.results[0])}).error(function(a){console.log("encounted error in queryRestaurantQueue: "+a),b(a)})}}}])}),define("public/local/system",[],function(){var a="//"+location.host+"/partials/";return{getTplAbsolutePath:function(b){return a+b}}}),define("restaurant-detail/controller",["app","./menu-controller","public/general/util","public/general/directive/ng-model","./menu-service","./menu-category-controller","./menu-item-controller","public/general/directive/drag-sort","./review-list-controller","./review-service","./review-item-controller","./file-uploader-controller","./picture-service","./picture-item-controller","public/local/restaurant-service","public/general/directive/confirm-hint","public/general/directive/prevent-spread"],function(a){var b=a("app");a("./menu-controller"),a("./review-list-controller"),a("./review-item-controller"),a("./file-uploader-controller"),a("./menu-service"),a("public/local/restaurant-service"),a("public/general/directive/confirm-hint"),a("public/general/directive/prevent-spread"),b.controller("restaurantDetailController",["$scope","$routeParams","restaurantService","menuService",function(a,b,c){a.goBack=function(){window.history.back()},a.restaurantId=b.restaurantId,c.getRestaurant(a.restaurantId).then(function(b){a.restaurant=b,a.newInfo=angular.copy(a.restaurant)},function(b){a.error=b}),a.editing=!1,a.edit=function(){a.editing=!0},a.cancel=function(){a.newInfo=angular.copy(a.restaurant),a.editing=!1},a.confirm=function(){a.editing=!1,c.updateRestaurantInfo(a.restaurantId,a.newInfo).then(function(){a.saved=!0},function(){a.saved=!1})}}])}),define("restaurant-detail/file-uploader-controller",["app","./picture-service","./picture-item-controller"],function(a){var b=a("app");a("./picture-service"),a("./picture-item-controller"),b.controller("fileUploader",["$cookies","$scope","pictureService","FileUploader","httpService",function(a,b,c,d,e){var f=new FormData;f.append("sessionId",a.token),f.append("restaurantId",b.restaurantId),b.uploader=new d({url:e.FILE_SERVER_URL,formData:[{sessionId:a.token},{restaurantId:b.restaurantId},{userId:a.username}],filter:[{name:"commentIsRequired",fn:function(a){return!!a.pictureComment}}]}),b.fileList=[],b.uploader.onBeforeUploadItem=function(a){a.formData.push({pictureComment:a.pictureComment})},b.upload=function(a){a.wantUpload=!0,a.pictureComment&&a.upload()},b.uploadAll=function(){b.uploader.queue.forEach(function(a){a.isSuccess||b.upload(a)})},b.uploader.onSuccessItem=function(a,c){var d=JSON.parse(c.data).results;b.fileList=b.fileList.concat(d)},c.getPictures(b.restaurantId).then(function(a){angular.forEach(a.results[0].uploadedPictures,function(a){b.fileList.push(a)})}),b.removePicture=function(a){c.removePicture({restaurantId:b.restaurantId,pictureId:a.pictureId}).then(function(){b.fileList=b.fileList.filter(function(b){return b.pictureId!=a.pictureId})})}}])}),define("restaurant-detail/menu-category-controller",["app","./menu-service"],function(a){var b=a("app");a("./menu-service"),b.controller("menuCategoryController",["$scope","menuService",function(a,b){b.modifyMenuCategory=b.modifyMenuCategory.setRequestStatus(a,"editStatus"),b.removeMenuCategory=b.removeMenuCategory.setRequestStatus(a,"deleteStatus"),b.addMenuItem=b.addMenuItem.setRequestStatus(a,"addMenuItemStatus");a.addingNewItem=!1,a.editing=!1,a.nameModified=a.category.categoryName,a.descriptionModified=a.category.categoryDescription,a.editCategory=function(){a.editing=!0,a.editStatus=a.REQUEST_STATUS.INIT},a.confirmEditCategory=function(){b.modifyMenuCategory({categoryName:a.nameModified,categoryDescription:a.descriptionModified,categoryId:a.category.categoryId},a.menu.restaurantId).then(function(){a.category.categoryName=a.nameModified,a.category.categoryDescription=a.descriptionModified,a.editing=!1})},a.sortMenuItem=function(c){var d=null,e=c.sortList;a.setAlert({showCover:!0,alertContent:"排序中..."}),e.forEach(function(a,b){a.id===c.dragNodeId&&b>0&&(d=c.sortList[b-1].id)}),b.sortMenuItem({itemId:c.dragNodeId,previousItemId:d,categoryId:a.category.categoryId},a.menu.restaurantId).then(function(){var b=[];e.forEach(function(c){b.push(a.getMenuItem(c.id))}),a.category.items=b,a.setAlert({showCover:!1})})},a.getMenuItem=function(b){var c;return a.category.items.some(function(a){return a.itemId===b?(c=a,!0):void 0}),c},a.deleteStatus=a.REQUEST_STATUS.INIT,a.removeMenuCategory=function(){b.removeMenuCategory(a.category.categoryId,a.menu.restaurantId).then(function(){a.menu.menuCategories=a.menu.menuCategories.filter(function(b){return b.categoryId!==a.category.categoryId})})},a.$on("collapse",function(b,c){a.collapse=c}),a.cancelEditCategory=function(){a.nameModified=a.category.categoryName,a.descriptionModified=a.category.categoryDescription,a.categoryEditForm.$setPristine(),a.editing=!1},a.addNewItem=function(){a.addingNewItem||(a.addingNewItem=!0,a.addMenuItemStatus=a.REQUEST_STATUS.INIT,a.menuItemForm={},a.menuItemFormValidation.$setPristine())},a.confirmAddItem=function(c){c&&b.addMenuItem(angular.extend(a.menuItemForm,{categoryId:a.category.categoryId}),a.menu.restaurantId).then(function(b){a.category.items=a.category.items.concat(b.results),a.addingNewItem=!1})},a.cancelAddItem=function(){a.addingNewItem=!1},a.toggleMenuCategory=function(a){$("#"+a).collapse("toggle")}}])}),define("restaurant-detail/menu-controller",["app","public/general/util","public/general/directive/ng-model","./menu-service","./menu-category-controller","./menu-item-controller","public/general/directive/drag-sort"],function(a){var b=a("app"),c=a("public/general/util");a("public/general/directive/ng-model"),a("./menu-service"),a("./menu-category-controller"),a("./menu-item-controller"),a("public/general/directive/drag-sort"),b.controller("menuController",["$scope","menuService","$timeout",function(a,b,d){function e(b){return void(a.menu=b)}function f(){a.categoryForm={categoryName:"",categoryDescription:""}}b.importMenu=b.importMenu.setRequestStatus(a,"importStatus"),b.sortMenuCategory=b.sortMenuCategory.setRequestStatus(a,"sortMenuCategoryStatus"),b.addMenuCategory=b.addMenuCategory.setRequestStatus(a,"addStatus"),a.adding=!1,a.menuFile=null,a.wantImport=!1,a.importStatus=a.REQUEST_STATUS.INIT,a.isExcel=function(){return c.isExcel(a.menuFile)},a.importMenu=function(){a.wantImport=!0,a.menuFile&&a.isExcel()&&b.importMenu(a.menuFile,a.restaurantId)},a.sortMenuCategoryStatus=a.REQUEST_STATUS.INIT,a.sortMenuCategory=function(c){var d=null,e=c.sortList;e.forEach(function(a,b){a.id===c.dragNodeId&&b>0&&(d=c.sortList[b-1].id)}),a.setAlert({showCover:!0,alertContent:"排序中..."}),b.sortMenuCategory({categoryId:c.dragNodeId,previousCategoryId:d},a.menu.restaurantId).then(function(){var b=[];e.forEach(function(c){b.push(a.getMenuCategory(c.id))}),a.menu.menuCategories=b,a.setAlert({showCover:!1})},function(){a.setAlert({showCover:!0,alertContent:"操作失败"})})},a.getMenuCategory=function(b){var c;return a.menu.menuCategories.some(function(a){return a.categoryId===b?(c=a,!0):void 0}),c},a.refreshMenu=function(){b.getMenu(a.restaurantId).then(function(a){e(a.results[0])},function(b){a.error=b})},a.refreshMenu(),a.collapseAll=function(b){a.$broadcast("collapse",b)},a.toAddMenuCategory=function(){a.adding=!0,a.addStatus=a.REQUEST_STATUS.INIT,f()},f(),a.addStatus=a.REQUEST_STATUS.INIT,a.addMenuCategory=function(c){c&&b.addMenuCategory(a.categoryForm,a.menu.restaurantId).then(function(b){f(),a.menu.menuCategories=a.menu.menuCategories.concat(b.results),a.adding=!1})}}])}),define("restaurant-detail/menu-item-controller",["app","./menu-service"],function(a){var b=a("app");a("./menu-service"),b.controller("menuItemController",["$scope","menuService",function(a,b){b.modifyMenuItem=b.modifyMenuItem.setRequestStatus(a,"editMenuItemStatus"),a.editing=!1,a.newItem=angular.copy(a.item),a.editItem=function(){a.editing||(a.editing=!0)},a.confirmEditItem=function(){b.modifyMenuItem({itemId:a.newItem.itemId,itemName:a.newItem.itemName,itemDescription:a.newItem.itemDescription,price:a.newItem.price,categoryId:a.category.categoryId},a.menu.restaurantId).then(function(){a.item.itemName=a.newItem.itemName,a.item.itemDescription=a.newItem.itemDescription,a.item.price=a.newItem.price,a.editing=!1})},a.cancelEditItem=function(){a.newItem=angular.copy(a.item),a.editing=!1},a.removeItem=function(){b.removeMenuItem({itemId:a.item.itemId,categoryId:a.category.categoryId},a.menu.restaurantId).then(function(){a.category.items=a.category.items.filter(function(b){return b.itemId!==a.item.itemId})})}}])}),define("restaurant-detail/menu-service",["app"],function(a){var b=a("app");b.service("menuService",["$http","$window","$cookies","httpService",function(a,b,c,d){var e={};return{getMenu:function(a){return e[a]||(e[a]=d.post({command:"getRestaurantMenu",data:{restaurantId:a}}).error(function(b){console.log("encounted error in getRestaurantMenu: "+b),e[a]=null})),e[a]},importMenu:function(a,b){return d.post({url:d.MENU_IMPORT_URL,isForm:!0,data:{file:a,restaurantId:b},config:{transformRequest:angular.identity,headers:{"Content-Type":void 0}}})},addMenuCategory:function(a,b){return d.post({command:"createMenuCategory",data:angular.extend(a,{restaurantId:b})})},modifyMenuCategory:function(a,b){return d.post({command:"modifyMenuCategory",data:angular.extend(a,{restaurantId:b})})},removeMenuCategory:function(a,b){return d.post({command:"deleteMenuCategory",data:{restaurantId:b,categoryId:a}})},addMenuItem:function(a,b){return d.post({command:"createMenuItem",data:angular.extend(a,{restaurantId:b})})},modifyMenuItem:function(a,b){return d.post({command:"modifyMenuItem",data:angular.extend(a,{restaurantId:b})})},removeMenuItem:function(a,b){return d.post({command:"deleteMenuItem",data:angular.extend(a,{restaurantId:b})})},sortMenuCategory:function(a,b){return d.post({command:"pivotMenuCategory",data:angular.extend(a,{restaurantId:b})})},sortMenuItem:function(a,b){return d.post({command:"pivotMenuItem",data:angular.extend(a,{restaurantId:b})})}}}])}),define("restaurant-detail/picture-item-controller",["app","./picture-service"],function(a){var b=a("app");a("./picture-service"),b.controller("pictureItemController",["$cookies","$scope","pictureService",function(a,b,c){b.file.pictureCommentCopy=b.file.pictureComment,b.modifyIntroduce=function(a){a&&c.modifyIntroduce({pictureId:b.file.pictureId,pictureComment:b.file.pictureCommentCopy,restaurantId:b.file.restaurantId}).then(function(){b.file.pictureComment=b.file.pictureCommentCopy,b.popoverScope.close()},function(){})}}])}),define("restaurant-detail/picture-service",["app"],function(a){var b=a("app");b.factory("pictureService",["$window","$cookies","httpService",function(a,b,c){return{upload:function(a,b){return c.post({url:c.FILE_SERVER_URL,isForm:!0,data:{restaurantId:b,file:a}})},getPictures:function(a){return c.post({command:"getRestaurantPicture",data:{restaurantId:a}})},removePicture:function(a){return c.post({command:"removeRestaurantPicture",data:a})},modifyIntroduce:function(a){return c.post({command:"modifyRestaurantPictureComment",data:a})}}}])}),define("restaurant-detail/review-item-controller",["app","./review-service"],function(a){var b=a("app");a("./review-service"),b.controller("reviewItemController",["$scope","reviewService",function(a,b){a.replying=!1,a.reply=function(){a.replying||(a.replying=!0)},a.confirmReply=function(){a.review.replyMessage=a.message,a.replying=!1,b.replyReview(a.restaurantId,a.review.reviewIndex,a.message).success(function(){a.saved=!0}).error(function(){a.saved=!1})},a.cancelReply=function(){a.review.replyMessage=null,a.replying=!1}}])}),define("restaurant-detail/review-list-controller",["app","./review-service"],function(a){var b=a("app");a("./review-service"),b.controller("reviewListController",["$scope","$routeParams","$timeout","reviewService",function(a,b,c,d){a.loading=!0,a.currentPage=1,a.selectPage=function(b){d.getReviewList(a.restaurantId,b-1).success(function(b){var c=b.results;a.loading=!1,a.reviewList=c,a.reviewList.forEach(function(a){a.rating/=2})})},a.selectPage(1)}])}),define("restaurant-detail/review-service",["app"],function(a){var b=a("app");b.factory("reviewService",["$window","$cookies","httpService",function(a,b,c){return{getReviewList:function(a,b){return c.post({command:"getRestaurantReviewList",data:{restaurantId:a,startIndex:10*b+1,size:10}}).error(function(a){console.log("encounted error in getReviews: "+a)})},replyReview:function(a,b,d){return c.post({command:"replyRestaurantReview",data:{restaurantId:a,reviewId:Number(b),replyMessage:d}}).error(function(a){console.log("encounted error in getReviews: "+a)})}}}])}),define("restaurant-list/controller",["app","public/general/pub-sub"],function(a){var b=a("app"),c=a("public/general/pub-sub");b.controller("restaurantListController",["$scope","restaurantService","menuService",function(a,b,d){a.loading=!0,a.includeHeader=!0,b.getMyRestaurantList().then(function(b){a.loading=!1,a.restaurantList=b.results,console.log("loading restaurantList"),c.publish("loadedRestaurantList",a.restaurantList),a.restaurantList.forEach(function(a){d.getMenu(a.restaurantId)})},function(b){a.error=b})}])}),define("route",["app","public/general/prototype","public/local/reservation-controller","public/local/confirmation-modal-controller","public/local/http","index/controller","login/controller","manage-account/controller","print-number/controller","public-wait-list/controller","restaurant-detail/controller","restaurant-list/controller","waiting-list/controller"],function(a){var b=a("app");a("public/general/prototype"),a("public/local/reservation-controller"),a("public/local/confirmation-modal-controller"),a("public/local/http"),a("index/controller"),a("login/controller"),a("manage-account/controller"),a("print-number/controller"),a("public-wait-list/controller"),a("restaurant-detail/controller"),a("restaurant-list/controller"),a("waiting-list/controller"),b.config(["$routeProvider",function(a){a.when("/login",{templateUrl:"partials/login.html?da24db24",controller:"loginController"}).when("/myRestaurants",{templateUrl:"partials/restaurantList.html?2917f51b",controller:"restaurantListController"}).when("/restaurant/:restaurantId",{templateUrl:"partials/restaurantDetails.html?81032fae",controller:"restaurantDetailController"}).when("/waitinglist/:restaurantId",{templateUrl:"partials/waitinglist.html?7c1b173c",controller:"waitingListController"}).when("/publicWaitList/:restaurantId",{templateUrl:"partials/publicWaitList.html?df1a028d",controller:"publicWaitListController"}).when("/printNumber/:unitId",{templateUrl:"partials/printNumber.html?e7fbcbf6",controller:"printNumberController"}).when("/manageAccount",{templateUrl:"partials/manageAccount.html?4575dacf",controller:"manageAccountController"}).otherwise({redirectTo:"/myRestaurants"})}])}),define("waiting-list/controller",["app","public/general/util","public/general/pub-sub","public/local/system","public/general/chinese-date","./reservation-list-controller","public/general/filter/width","public/local/restaurant-service","./waiting-list-service","public/local/reservation-service","public/general/speech-service","public/general/directive/popover"],function(a){var b=a("app"),c=a("public/general/util"),d=a("public/general/pub-sub"),e=a("public/local/system"),f=a("public/general/chinese-date");a("./reservation-list-controller"),a("public/local/restaurant-service"),a("./waiting-list-service"),a("public/local/reservation-service"),a("public/general/speech-service"),a("public/general/directive/popover"),b.controller("waitingListController",["$modal","$scope","$routeParams","$timeout","$cookies","$window","$mdToast","restaurantService","waitingListService","reservationService","dataService","$filter","speechService",function(a,b,g,h,i,j,k,l,m,n,o,p,q){function r(a){a=a||b.reservationList,b.reservationList=p("orderBy")(a,"reservationInfo.reservationTime")}function s(){b.waitForm={name:"","phone.number":"",partyTypeId:"",restaurantId:b.restaurantId,queueType:o.queueType.wait}}function t(){b.reservationForm={restaurantId:b.restaurantId,name:"","phone.number":"",partyTypeId:b.partyTypeList[0].partyTypeId,reservationTime:new Date,reservationType:b.reservationTypeMap.reservationDesk.value,reservableId:b.restaurant.reservableRooms[0]?b.restaurant.reservableRooms[0].reservableId:"",headCount:""}}function u(a){return v(a).partyTypeDescription}function v(a){var c;return b.partyTypeList.some(function(b){return b.partyTypeId===a?(c=b,!0):void 0}),c}function w(a,c){var d;return c?d=c.partyTypeDescription:(d=u(a.partyTypeId),b.reservationList.some(function(b,c){return b.unitId===a.unitId?(a.position=c,!0):void 0})),{unit:a,partyTypeDescription:d,printTime:new f}}b.restaurantId=g.restaurantId;var x=null;b.goBack=function(){window.history.back()},b.reservationTypeMap={reservationDesk:{text:"预约留台",value:"1"},reservationRoom:{text:"预约房间",value:"2"}},b.reservationTypeArray=c.getArray(b.reservationTypeMap),l.getRestaurant(b.restaurantId).then(function(a){b.partyTypeList=a.partyTypeInfos,b.restaurant=a,b.maxQueueLength=a.restaurantSettings.maxQueueLength,t()},function(a){b.error=a}),b.resetWaitingList=function(){l.resetWaitingList(b.restaurantId).success(function(){y()})},b.setMaxQueue=function(a){a&&l.setMaxQueue(b.restaurantId,b.maxQueueLength).success(function(){b.restaurant.restaurantSettings.maxQueueLength=b.maxQueueLength,b.modifyMaxQueuePopover.close()})},b.stopReservation=function(){l.acceptReservation(b.restaurantId,!1).success(function(){b.restaurant.restaurantSettings.acceptReservation=!1})},b.startReservation=function(){l.acceptReservation(b.restaurantId,!0).success(function(){b.restaurant.restaurantSettings.acceptReservation=!0
})},b.stopQueue=function(){l.enableQueue(b.restaurantId,!1).success(function(){b.restaurant.restaurantSettings.enableQueue=!1})},b.startQueue=function(){l.enableQueue(b.restaurantId,!0).success(function(){b.restaurant.restaurantSettings.enableQueue=!0})},b.waitingList=[];var y=function(){l.getWaitingList(b.restaurantId,function(a,c){b.error=a,b.waitingList=c.waitingList,r(c.reservationList),b.reservationCompleteList=c.completeList.filter(function(a){return!!a.reservationInfo}),b.waitingCompleteList=c.completeList.filter(function(a){return!a.reservationInfo})})};y(),b.$on("$destroy",function(){d.unSubscribe("newReservation",y)}),d.subscribe("newReservation",y),b.call=function(a,c){var e=q.createMsg();c=c||"预",e.text=c+","+a.unitId.substring(c.length),q.speak(e),m.callUser(b.restaurantId,a.unitId).success(function(b){a.callCount=b.results[0].callCount,d.publish("businessSuccess",{msg:"已发送"})}).error(function(){}),x&&x.postMessage({type:"call",data:{unitIdPrefix:c,unit:a}},window.location.href)},b.openPublicWaitListWindow=function(){var a="left=0,top=0,width="+screen.width+",height="+screen.height;x=j.open("#/publicWaitList/"+b.restaurantId,"publicWindow",a),x.focus();for(var c=x.data={partyTypes:b.partyTypeList,lastCalledNumbers:{}},d=0;d<c.partyTypes.length;d++){var e=c.partyTypes[d],f=null;b.waitingList[d+1].length>0&&(f=b.waitingList[d+1][0]),c.lastCalledNumbers[e.unitIdPrefix]=f}x.postMessage({type:"initData",data:c},window.location.href)},b.removeReservation=function(a){m.removeReservation(b.restaurantId,a).success(function(){b.reservationList=b.reservationList.filter(function(b){return b.unitId!==a}),y()})},b.removeWaiting=function(a,c){m.removeWaiting(b.restaurantId,a).success(function(){b.waitingList[c]=b.waitingList[c].filter(function(b){return b.unitId!==a}),y()})},s(),b.addWaitUser=function(a,c){if(a){b.waitForm.partyTypeId=c;{var d=b.openTempPrintView("printWindow");m.addWaitUser(b.waitForm).success(function(a){var e=a.results[0];b.waitingList[c].push(e),s(),d.printData=w(a.results[0],v(c)),d.requestPrint&&d.requestPrint(),b.waitFormValidation.$setPristine()})}}},b.addReservationUser=function(){var a=angular.copy(b.reservationForm);a.reservationType===b.reservationTypeMap.reservationRoom.value?(a.partyTypeId=0,a.queueType=o.queueType.reserveRoom):(a.queueType=o.queueType.reserveParty,delete a.reservableId),delete a.reservationType,m.addReservationUser(a).success(function(a){b.reservationList.push(a.results[0]),t(),b.reservationFormValidation.$setPristine(),r()})},b.openConfirmation=function(c,d,e){var f=a.open({templateUrl:"confirmationModal.html",size:"sm",controller:"confirmationModalController",resolve:{queueUnit:function(){return c[d]}}});f.result.then(function(){b.remove(c,d,e)},function(){})},b.openTempPrintView=function(a){return j.open(e.getTplAbsolutePath("printNumber.html"),a,"left=0,top=0")},b.openPrintView=function(a,b,c){c=c||"";var d=j.open(e.getTplAbsolutePath("printNumber.html"),c,"left=0,top=0");d.printData=w(a,b)},b.reservationStatusMap=o.reservationStatus}])}),define("waiting-list/reservation-list-controller",["app","public/general/chinese-date","public/general/filter/width"],function(a){var b=a("app"),c=a("public/general/chinese-date");a("public/general/filter/width"),b.controller("reservationListController",["$scope","$q","reservationService","dataService",function(a,b,d,e){function f(){var c=b.defer();return a.reservationList?c.resolve(a.reservationList):a.$watch("reservationList",function(b){b&&c.resolve(a.reservationList)}),c.promise}function g(){a.showDateList.forEach(function(b){a.getReservationSummary(b).then(function(c){a.showReservationList[b.getTime()]=c})})}var h=2015,i=(new c).getFullYear()+1;a.yearList=[];for(var j=h;i>=j;j++)a.yearList.push(j);a.monthList=[];for(var j=1;12>=j;j++)a.monthList.push(j);a.date={set year(a){this._year=parseInt(a)},get year(){return this._year},set month(a){this._month=parseInt(a)},get month(){return this._month}},a.date.year=(new c).getFullYear(),a.date.month=(new c).getMonth()+1,a.weekNameList=["一","二","三","四","五","六","日"].map(function(a){return"周"+a}),a.weekList=[],a.showDateList=[],a.showReservationList={},a.SHOW_MODE={CALENDAR:1,LIST:2},a.showMode=a.SHOW_MODE.LIST,a.last=function(){a.date.month>1?a.date.month-=1:a.date.year>a.yearList[0]&&(a.date.year-=1,a.date.month=12)},a.next=function(){a.date.month<12?a.date.month+=1:a.date.year<a.yearList[a.yearList.length-1]&&(a.date.year+=1,a.date.month=1)},a.toToday=function(){a.date.year=(new Date).getFullYear(),a.date.month=(new Date).getMonth()+1},a.accept=function(b,c,f){a.submitted=!0,b&&d.accept({restaurantId:c.restaurantId,unitId:c.unitId,comment:f}).success(function(){a.submitted=!1,a.$broadcast("reservationStatusChange"),a.$broadcast("closePopover","acceptPopover"),c.reservationStatus=e.reservationStatus.accept,c.reservationComment=f})},a.refuse=function(b,c,f){a.submitted=!0,b&&d.refuse({restaurantId:c.restaurantId,unitId:c.unitId,comment:f}).success(function(){a.submitted=!1,a.$broadcast("reservationStatusChange"),a.$broadcast("closePopover","refusePopover"),c.reservationStatus=e.reservationStatus.refuse,c.reservationComment=f})},a.getReservationSummary=function(b){var d=6,e=[],g=[],h=[],i=[],j=[];return f().then(function(f){return f.forEach(function(d){b.isSameDay(new c(1e3*d.reservationInfo.reservationTime))&&(d.reservationStatus===a.reservationStatusMap.waitConfirm?g.push(d):e.push(d),h.push(d))}),j=h,h.length>d&&(i=h.slice(d-1),h=h.slice(0,d-1)),{replied:e,noReply:g,directShow:h,rest:i,all:j}})},a.reservationListUrl="partials/reservation-list.html",a.$watch("date",function(b){var d=c.getCountOfMonth(b.year,b.month);a.showDateList=[],a.showReservationList={};for(var e=1;d>=e;++e)a.showDateList.push(new c(b.year,b.month-1,e));for(var f=a.showDateList[0].getDay()||7,e=1;f>e;++e)a.showDateList.unshift(new c(b.year,b.month-1,1-e));f=a.showDateList[a.showDateList.length-1].getDay()||7;for(var e=1;7-f>=e;++e)a.showDateList.push(new c(b.year,b.month-1,d+e));g()},!0),a.$watch("showDateList",function(){a.weekList=[];for(var b=0;b<a.showDateList.length;++b)b%7==0?a.weekList.push([a.showDateList[b]]):a.weekList[a.weekList.length-1].push(a.showDateList[b])}),a.$watchCollection("reservationList",function(){g()}),a.$on("reservationStatusChange",function(){g()})}])}),define("waiting-list/waiting-list-service",["app"],function(a){var b=a("app");b.factory("waitingListService",["$window","$cookies","httpService",function(a,b,c){return{lastCalledNumber:0,callUser:function(a,b){return this.lastCalledNumber=b,c.post({command:"callUser",data:{restaurantId:a,unitId:b}})},removeReservation:function(a,b){return c.post({command:"reservationToComplete",data:{restaurantId:a,unitId:b}})},removeWaiting:function(a,b){return c.post({command:"waitingToComplete",data:{restaurantId:a,unitId:b}})},addUser:function(a){return c.post({command:"addAdhocUserToQueue",data:a})},addWaitUser:function(a){return this.addUser(a)},addReservationUser:function(a){return a.reservationTime instanceof Date&&(a.reservationTime=Math.round(a.reservationTime.getTime()/1e3)),a.partyTypeId=parseInt(a.partyTypeId),this.addUser(a)}}}])}),seajs.use("main");
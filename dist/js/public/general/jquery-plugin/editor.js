/*! ppz_website 2015-01-27 4:31:55 PM */
"use strict";define("public/general/jquery-plugin/editor",[],function(){!function(a){function b(a){return a=a.trim(),a&&(a=a.replace(/<div/g,"<p").replace(/<\/div>/g,"</p>"),a=a.replace(/<(\/)?br>/g,""),a=a.replace(/\u200b/g,""),a=a.replace(/<p>\s*<\/p>/g,""),a=a.replace(/class=['"]info-center['"]/g,""),a=a.replace(/<p((.(?!<p|class=|<\/p))*)(?=<img|<iframe)/g,"<p class='info-center' $1"),a&&!/^<p/.test(a)&&(a=a.replace(/<p/,"</p><p"),a="<p>"+a,/<\/p>/.test(a)||(a+="</p>")),a=a.replace(/(<iframe[^>]*src=['"])http:\/\/player.youku.com\/embed\/(.+)(['"][^>]*>)/g,"$1http://pic.wanmeiyueyu.com/upload/youkukilledrelate.html#$2$3")),a}a.fn.cleanHtml=function(){return b(a(this).hasClass("source-mode")?a(this).text():a(this).html())},a.fn.wysiwyg=function(c){var d,e,f,g=this,h=function(){e.activeToolbarClass&&a(e.toolbarSelector).find(f).each(function(){var b=a(this).data(e.commandRole);document.queryCommandState(b)?a(this).addClass(e.activeToolbarClass):a(this).removeClass(e.activeToolbarClass)})},i=function(a,b){var c=a.split(" "),d=c.shift(),e=c.join(" ")+(b||""),f=document.execCommand(d,0,e);return h(),f},j=function(b){a.each(b,function(a,b){g.keydown(a,function(a){g.attr("contenteditable")&&g.is(":visible")&&(a.preventDefault(),a.stopPropagation(),i(b))}).keyup(a,function(a){g.attr("contenteditable")&&g.is(":visible")&&(a.preventDefault(),a.stopPropagation())})})},k=function(){var a=window.getSelection();return a.getRangeAt&&a.rangeCount?a.getRangeAt(0):void 0},l=function(){d=k()},m=function(){var a=window.getSelection();if(d){try{a.removeAllRanges()}catch(b){document.body.createTextRange().select(),document.selection.empty()}a.addRange(d)}},n=function(a){g.focus(),i("inserthtml","<p><img src='"+a+"' /></p>")},o=function(a,b){m(),document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",0,b||"transparent"),l(),a.data(e.selectionMarker,b)},p=function(c,d){function e(){""===g.html().replace(/\s+/g,"")&&i("insertHtml","<p>&#8203;</p>")}c.find(f).click(function(){m(),g.focus(),i(a(this).data(d.commandRole)),l()}),c.find("[data-toggle=dropdown]").click(m),c.find("input[type=text][data-"+d.commandRole+"]").on("webkitspeechchange change",function(){var b=this.value;this.value="",m(),b&&(g.focus(),i(a(this).data(d.commandRole),b)),l()}).on("focus",function(){var b=a(this);b.data(d.selectionMarker)||(o(b,d.selectionColor),b.focus())}).on("blur",function(){var b=a(this);b.data(d.selectionMarker)&&o(b,!1)}),c.find("input[type=file][data-"+d.commandRole+"]").change(function(){m(),"file"===this.type&&this.files&&this.files.length>0&&g.trigger("fileSelected",[this.files]),l(),this.value=""}),g.on("fileUploaded",function(a,b){n(b)}),c.find("[data-operation='full-screen']").on("click",function(){a("#editor-zone").toggleClass("full-screen"),a("body").css(a("#editor-zone").hasClass("full-screen")?{overflow:"hidden"}:{overflow:""})}),c.find("[data-operation=source-mode]").on("click",function(){g.toggleClass("source-mode");var d,e=/</g,h=/>/g;g.hasClass("source-mode")?(a(this).attr("data-original-title","源码模式"),c.find(f).addClass("disabled"),c.find("[data-toggle],#pictureBtn").addClass("disabled"),c.find("[type=file]").attr("disabled",""),d=b(g.html()),d=d.replace(/&/g,"&amp;"),d=d.replace(/(<p[^>]*>)/g,"$1&nbsp;&nbsp;"),d=d.replace(e,"<br/>&lt;").replace(h,"&gt;<br/>"),g.focus(),g.html(""),i("insertHtml",d)):(a(this).attr("data-original-title","编辑模式"),c.find(f).removeClass("disabled"),c.find("[data-toggle],#pictureBtn,[type=file]").removeClass("disabled"),c.find("[type=file]").removeAttr("disabled"),d=g.text(),d=d.replace(/[\u00a0\u0020\u0009]+/g," "),d=d.replace(/>[\u00a0\u0020\u0009]{1,2}/g,">"),g.focus(),g.html(""),i("insertHtml",d))}),function(){var a=new MutationObserver(function(){e(),g.trigger("editorContentChanged",[g.cleanHtml()])}),b={subtree:!0,characterData:!0,childList:!0,attributes:!0};a.observe(g[0],b)}(),g.bind("keypress",function(){e()})},q=function(){g.on("dragenter dragover",!1).on("drop",function(a){var b=a.originalEvent.dataTransfer;a.stopPropagation(),a.preventDefault(),b&&b.files&&b.files.length>0&&n(b.files)})};return e=a.extend({},a.fn.wysiwyg.defaults,c),f="a[data-"+e.commandRole+"],button[data-"+e.commandRole+"],input[type=button][data-"+e.commandRole+"]",j(e.hotKeys),e.dragAndDropImages&&q(),p(a(e.toolbarSelector),e),g.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){l(),h()}),a(window).bind("touchend",function(a){var b=g.is(a.target)||g.has(a.target).length>0,c=k(),d=c&&c.startContainer===c.endContainer&&c.startOffset===c.endOffset;(!d||b)&&(l(),h())}),this},a.fn.wysiwyg.defaults={hotKeys:{"ctrl+b meta+b":"bold","ctrl+i meta+i":"italic","ctrl+u meta+u":"underline","ctrl+z meta+z":"undo","ctrl+y meta+y meta+shift+z":"redo","ctrl+l meta+l":"justifyleft","ctrl+r meta+r":"justifyright","ctrl+e meta+e":"justifycenter","ctrl+j meta+j":"justifyfull","shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,fileUploadError:function(a,b){console.log("File upload error",a,b)}}}(window.jQuery)});
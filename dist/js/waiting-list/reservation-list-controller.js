/*! ppz_website 2015-02-02 10:07:15 AM */
"use strict";define("waiting-list/reservation-list-controller",["app","public/general/chinese-date","public/general/filter/width"],function(a){var b=a("app"),c=a("public/general/chinese-date");a("public/general/filter/width"),b.controller("reservationListController",["$scope","$q","reservationService","dataService",function(a,b,d,e){function f(){var c=b.defer();return a.reservationList?c.resolve(a.reservationList):a.$watch("reservationList",function(b){b&&c.resolve(a.reservationList)}),c.promise}function g(){a.showDateList.forEach(function(b){a.getReservationSummary(b).then(function(c){a.showReservationList[b.getTime()]=c})})}var h=2015,i=(new c).getFullYear()+1;a.yearList=[];for(var j=h;i>=j;j++)a.yearList.push(j);a.monthList=[];for(var j=1;12>=j;j++)a.monthList.push(j);a.date={set year(a){this._year=parseInt(a)},get year(){return this._year},set month(a){this._month=parseInt(a)},get month(){return this._month}},a.date.year=(new c).getFullYear(),a.date.month=(new c).getMonth()+1,a.weekNameList=["一","二","三","四","五","六","日"].map(function(a){return"周"+a}),a.weekList=[],a.showDateList=[],a.showReservationList={},a.SHOW_MODE={CALENDAR:1,LIST:2},a.showMode=a.SHOW_MODE.CALENDAR,a.last=function(){a.date.month>1?a.date.month-=1:a.date.year>a.yearList[0]&&(a.date.year-=1,a.date.month=12)},a.next=function(){a.date.month<12?a.date.month+=1:a.date.year<a.yearList[a.yearList.length-1]&&(a.date.year+=1,a.date.month=1)},a.toToday=function(){a.date.year=(new Date).getFullYear(),a.date.month=(new Date).getMonth()+1},a.accept=function(b,c,f){a.submitted=!0,b&&d.accept({restaurantId:c.restaurantId,unitId:c.unitId,comment:f}).success(function(){a.submitted=!1,a.$broadcast("reservationStatusChange"),a.$broadcast("closePopover","acceptPopover"),c.reservationStatus=e.reservationStatus.accept,c.reservationComment=f})},a.refuse=function(b,c,f){a.submitted=!0,b&&d.refuse({restaurantId:c.restaurantId,unitId:c.unitId,comment:f}).success(function(){a.submitted=!1,a.$broadcast("reservationStatusChange"),a.$broadcast("closePopover","refusePopover"),c.reservationStatus=e.reservationStatus.refuse,c.reservationComment=f})},a.getReservationSummary=function(b){var d=6,e=[],g=[],h=[],i=[],j=[];return f().then(function(f){return f.forEach(function(d){b.isSameDay(new c(1e3*d.reservationInfo.reservationTime))&&(d.reservationStatus===a.reservationStatusMap.waitConfirm?g.push(d):e.push(d),h.push(d))}),j=h,h.length>d&&(i=h.slice(d-1),h=h.slice(0,d-1)),{replied:e,noReply:g,directShow:h,rest:i,all:j}})},a.reservationListUrl="partials/reservation-list.html",a.$watch("date",function(b){var d=c.getCountOfMonth(b.year,b.month);a.showDateList=[],a.showReservationList={};for(var e=1;d>=e;++e)a.showDateList.push(new c(b.year,b.month-1,e));for(var f=a.showDateList[0].getDay()||7,e=1;f>e;++e)a.showDateList.unshift(new c(b.year,b.month-1,1-e));f=a.showDateList[a.showDateList.length-1].getDay()||7;for(var e=1;7-f>=e;++e)a.showDateList.push(new c(b.year,b.month-1,d+e));g()},!0),a.$watch("showDateList",function(){a.weekList=[];for(var b=0;b<a.showDateList.length;++b)b%7==0?a.weekList.push([a.showDateList[b]]):a.weekList[a.weekList.length-1].push(a.showDateList[b])}),a.$watchCollection("reservationList",function(){g()}),a.$on("reservationStatusChange",function(){g()})}])});
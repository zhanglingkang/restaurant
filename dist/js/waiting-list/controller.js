/*! ppz_website 2015-02-05 3:20:31 PM */
"use strict";define("waiting-list/controller",["app","public/general/util","public/general/pub-sub","public/local/system","public/general/chinese-date","./reservation-list-controller","public/general/filter/width","public/local/restaurant-service","./waiting-list-service","public/local/reservation-service","public/general/speech-service","public/general/directive/popover"],function(a){var b=a("app"),c=a("public/general/util"),d=a("public/general/pub-sub"),e=a("public/local/system"),f=a("public/general/chinese-date");a("./reservation-list-controller"),a("public/local/restaurant-service"),a("./waiting-list-service"),a("public/local/reservation-service"),a("public/general/speech-service"),a("public/general/directive/popover"),b.controller("waitingListController",["$modal","$scope","$routeParams","$timeout","$cookies","$window","$mdToast","restaurantService","waitingListService","reservationService","dataService","$filter","speechService",function(a,b,g,h,i,j,k,l,m,n,o,p,q){function r(a){a=a||b.reservationList,b.reservationList=p("orderBy")(a,"reservationInfo.reservationTime")}function s(){b.waitForm={name:"","phone.number":"",partyTypeId:"",restaurantId:b.restaurantId,queueType:o.queueType.wait}}function t(){b.reservationForm={restaurantId:b.restaurantId,name:"","phone.number":"",partyTypeId:b.partyTypeList[0].partyTypeId,reservationTime:new Date,reservationType:b.reservationTypeMap.reservationDesk.value,reservableId:b.restaurant.reservableRooms[0]?b.restaurant.reservableRooms[0].reservableId:"",headCount:""}}function u(a){return v(a).partyTypeDescription}function v(a){var c;return b.partyTypeList.some(function(b){return b.partyTypeId===a?(c=b,!0):void 0}),c}function w(a,c){var d;return c?d=c.partyTypeDescription:(d=u(a.partyTypeId),b.reservationList.some(function(b,c){return b.unitId===a.unitId?(a.position=c,!0):void 0})),{unit:a,partyTypeDescription:d,printTime:new f}}b.restaurantId=g.restaurantId;var x=null;b.goBack=function(){window.history.back()},b.reservationTypeMap={reservationDesk:{text:"预约留台",value:"1"},reservationRoom:{text:"预约房间",value:"2"}},b.reservationTypeArray=c.getArray(b.reservationTypeMap),l.getRestaurant(b.restaurantId).then(function(a){b.partyTypeList=a.partyTypeInfos,b.restaurant=a,b.maxQueueLength=a.restaurantSettings.maxQueueLength,t()},function(a){b.error=a}),b.resetWaitingList=function(){l.resetWaitingList(b.restaurantId).success(function(){y()})},b.setMaxQueue=function(a){a&&l.setMaxQueue(b.restaurantId,b.maxQueueLength).success(function(){b.restaurant.restaurantSettings.maxQueueLength=b.maxQueueLength,b.modifyMaxQueuePopover.close()})},b.stopReservation=function(){l.acceptReservation(b.restaurantId,!1).success(function(){b.restaurant.restaurantSettings.acceptReservation=!1})},b.startReservation=function(){l.acceptReservation(b.restaurantId,!0).success(function(){b.restaurant.restaurantSettings.acceptReservation=!0})},b.stopQueue=function(){l.enableQueue(b.restaurantId,!1).success(function(){b.restaurant.restaurantSettings.enableQueue=!1})},b.startQueue=function(){l.enableQueue(b.restaurantId,!0).success(function(){b.restaurant.restaurantSettings.enableQueue=!0})},b.waitingList=[];var y=function(){l.getWaitingList(b.restaurantId,function(a,c){b.error=a,b.waitingList=c.waitingList,r(c.reservationList),b.reservationCompleteList=c.completeList.filter(function(a){return!!a.reservationInfo}),b.waitingCompleteList=c.completeList.filter(function(a){return!a.reservationInfo})})};y(),b.$on("$destroy",function(){d.unSubscribe("newReservation",y)}),d.subscribe("newReservation",y),b.call=function(a,c){var e=q.createMsg();c=c||"预",e.text=c+","+a.unitId.substring(c.length),q.speak(e),m.callUser(b.restaurantId,a.unitId).success(function(b){a.callCount=b.results[0].callCount,d.publish("businessSuccess",{msg:"已发送"})}).error(function(){}),x&&x.postMessage({type:"call",data:{unitIdPrefix:c,unit:a}},window.location.href)},b.openPublicWaitListWindow=function(){var a="left=0,top=0,width="+screen.width+",height="+screen.height;x=j.open("#/publicWaitList/"+b.restaurantId,"publicWindow",a),x.focus();for(var c=x.data={partyTypes:b.partyTypeList,lastCalledNumbers:{}},d=0;d<c.partyTypes.length;d++){var e=c.partyTypes[d],f=null;b.waitingList[d+1].length>0&&(f=b.waitingList[d+1][0]),c.lastCalledNumbers[e.unitIdPrefix]=f}x.postMessage({type:"initData",data:c},window.location.href)},b.removeReservation=function(a){m.removeReservation(b.restaurantId,a).success(function(){b.reservationList=b.reservationList.filter(function(b){return b.unitId!==a}),y()})},b.removeWaiting=function(a,c){m.removeWaiting(b.restaurantId,a).success(function(){b.waitingList[c]=b.waitingList[c].filter(function(b){return b.unitId!==a}),y()})},s(),b.addWaitUser=function(a,c){if(a){b.waitForm.partyTypeId=c;{var d=b.openTempPrintView("printWindow");m.addWaitUser(b.waitForm).success(function(a){var e=a.results[0];b.waitingList[c].push(e),s(),d.printData=w(a.results[0],v(c)),d.requestPrint&&d.requestPrint(),b.waitFormValidation.$setPristine()})}}},b.addReservationUser=function(){var a=angular.copy(b.reservationForm);a.reservationType===b.reservationTypeMap.reservationRoom.value?(a.partyTypeId=0,a.queueType=o.queueType.reserveRoom):(a.queueType=o.queueType.reserveParty,delete a.reservableId),delete a.reservationType,m.addReservationUser(a).success(function(a){b.reservationList.push(a.results[0]),t(),b.reservationFormValidation.$setPristine(),r()})},b.openConfirmation=function(c,d,e){var f=a.open({templateUrl:"confirmationModal.html",size:"sm",controller:"confirmationModalController",resolve:{queueUnit:function(){return c[d]}}});f.result.then(function(){b.remove(c,d,e)},function(){})},b.openTempPrintView=function(a){return j.open(e.getTplAbsolutePath("printNumber.html"),a,"left=0,top=0")},b.openPrintView=function(a,b,c){c=c||"";var d=j.open(e.getTplAbsolutePath("printNumber.html"),c,"left=0,top=0");d.printData=w(a,b)},b.reservationStatusMap=o.reservationStatus}])});
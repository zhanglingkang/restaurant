/*! ppz_website 2015-01-12 6:59:27 PM */
"use strict";define(function(a){var b=a("app"),c=a("public/general/util"),d=a("public/general/pub-sub");a("public/local/restaurant-service"),a("./waiting-list-service"),a("public/local/reservation-service"),a("public/general/speech-service"),a("public/general/directive/popover"),b.controller("waitingListController",["$modal","$scope","$routeParams","$timeout","$cookies","$window","$mdToast","restaurantService","waitingListService","reservationService","dataService","$filter","speechService",function(a,b,e,f,g,h,i,j,k,l,m,n,o){b.restaurantId=e.restaurantId;var p=null;b.goBack=function(){window.history.back()},b.reservationTypeMap={reservationDesk:{text:"预约留台",value:"1"},reservationRoom:{text:"预约房间",value:"2"}},b.reservationTypeArray=c.getArray(b.reservationTypeMap),b.newReserve={time:new Date,typeId:"",reservableId:"",number:"",reservationType:b.reservationTypeMap.reservationDesk.value},j.getRestaurant(b.restaurantId).then(function(a){b.partyTypeList=a.partyTypeInfos,b.newReserve.typeId=b.partyTypeList[0].partyTypeId,b.restaurant=a,b.newReserve.reservableId=b.restaurant.reservableRooms[0]?b.restaurant.reservableRooms[0].reservableId:"",b.maxQueueLength=a.restaurantSettings.maxQueueLength},function(a){b.error=a}),b.resetWaitingList=function(){j.resetWaitingList(b.restaurantId).success(function(){q()})},b.setMaxQueue=function(a){a&&j.setMaxQueue(b.restaurantId,b.maxQueueLength).success(function(){b.restaurant.restaurantSettings.maxQueueLength=b.maxQueueLength,b.modifyMaxQueuePopover.close()})},b.stopReservation=function(){j.acceptReservation(b.restaurantId,!1).success(function(){b.restaurant.restaurantSettings.acceptReservation=!1})},b.startReservation=function(){j.acceptReservation(b.restaurantId,!0).success(function(){b.restaurant.restaurantSettings.acceptReservation=!0})},b.stopQueue=function(){j.enableQueue(b.restaurantId,!1).success(function(){b.restaurant.restaurantSettings.enableQueue=!1})},b.startQueue=function(){j.enableQueue(b.restaurantId,!0).success(function(){b.restaurant.restaurantSettings.enableQueue=!0})},b.waitingList=[],Date.prototype.toString=function(){return n("date")(this,"yyyy-MM-dd")};var q=function(){j.getWaitingList(b.restaurantId,function(a,c){b.error=a,b.waitingList=c.waitingList,b.reservationList=c.reservationList,b.reservationCompleteList=c.completeList.filter(function(a){return!!a.reservationInfo}),b.waitingCompleteList=c.completeList.filter(function(a){return!a.reservationInfo})})};q(),b.$on("$destroy",function(){d.unSubscribe("newReservation",q)}),d.subscribe("newReservation",q),b.call=function(a,c){var e=o.createMsg();c=c||"预",e.text=c+","+a.unitId.substring(c.length),o.speak(e),k.callUser(b.restaurantId,a.unitId).success(function(b){a.callCount=b.results[0].callCount,d.publish("businessSuccess",{msg:"已发送"})}).error(function(){}),p&&p.postMessage({type:"call",data:{unitIdPrefix:c,unit:a}},window.location.href)},b.openPublicWaitListWindow=function(){var a="left=0,top=0,width="+screen.width+",height="+screen.height;p=h.open("#/publicWaitList/"+b.restaurantId,"publicWindow",a),p.focus();for(var c=p.data={partyTypes:b.partyTypeList,lastCalledNumbers:{}},d=0;d<c.partyTypes.length;d++){var e=c.partyTypes[d],f="--";b.waitingList[d+1].length>0&&(f=b.waitingList[d+1][0].unitId),c.lastCalledNumbers[e.unitIdPrefix]=f}p.postMessage({type:"initData",data:c},window.location.href)},b.removeReservation=function(a){k.removeReservation(b.restaurantId,a).success(function(){b.reservationList=b.reservationList.filter(function(b){return b.unitId!==a}),q()})},b.removeWaiting=function(a,c){k.removeWaiting(b.restaurantId,a).success(function(){b.waitingList[c]=b.waitingList[c].filter(function(b){return b.unitId!==a}),q()})},b.addUser=function(a){var c,d=a?b.newReserve.time:null,e=b.newReserve.typeId;b.newReserve.reservationType===b.reservationTypeMap.reservationRoom.value?(e=0,c=k.reserveRoom(b.restaurantId,b.newReserve.name,e,b.newReserve.phone,d,b.newReserve.reservableId,b.newReserve.number)):c=k.addUser(b.restaurantId,b.newReserve.name,b.newReserve.typeId,b.newReserve.phone,d),c.success(function(c){var d=c.results[0];a?b.reservationList.push(d):(0==b.waitingList[e].length&&p&&(p.lastReplacedUnit=d,p.lastReplacedUnitPrefix=d.unitId.charAt(0)),b.waitingList[e].push(d)),b.newReserve={time:new Date,typeId:b.newReserve.typeId,reservableId:b.restaurant.reservableRooms[0]?b.restaurant.reservableRooms[0].reservableId:"",number:"",reservationType:b.reservationTypeMap.reservationDesk.value},b.reserveForm.$setPristine()})},b.reserveRoom=function(){reserve?b.newReserve.time:null},b.openConfirmation=function(c,d,e){var f=a.open({templateUrl:"confirmationModal.html",size:"sm",controller:"confirmationModalController",resolve:{queueUnit:function(){return c[d]}}});f.result.then(function(){b.remove(c,d,e)},function(){})},b.openPrintView=function(a,c){var d=h.open("#/printNumber/"+a.unitId);if(c)d.printPartyTypeDescription=c.partyTypeDescription;else for(var e=a.unitId.charAt(0),f=0;f<b.partyTypeList.length;f++){var c=b.partyTypeList[f];if(e==c.unitIdPrefix){d.printPartyTypeDescription="(预约)"+c.partyTypeDescription;break}}d.printUnitId=a.unitId},b.reservationStatusMap=m.reservationStatus,b.accept=function(a,c,d){b.submitted=!0,a&&l.accept({restaurantId:c.restaurantId,unitId:c.unitId,comment:d}).success(function(){b.submitted=!1,b.$broadcast("closePopover","acceptPopover"),c.reservationStatus=m.reservationStatus.accept,c.reservationComment=d})},b.refuse=function(a,c,d){b.submitted=!0,a&&l.refuse({restaurantId:c.restaurantId,unitId:c.unitId,comment:d}).success(function(){b.submitted=!1,b.$broadcast("closePopover","refusePopover"),c.reservationStatus=m.reservationStatus.refuse,c.reservationComment=d})},b.reservationStatusMap=m.reservationStatus}])});